<script>
    let proId = null;
    let dbNoUpgradeDefination = null;
    async function initDefinitionPage ()
    {

        proId = 'def_' + localStorage.getItem( 'selectedProject' );
        dbNoUpgradeDefination = await new noUpgrade( proId );
        let dbUpgrade = await new upgrade( proId );

        if ( !await dbNoUpgradeDefination.isTableExist( 'definition' ) )
        {
            await dbUpgrade.createKeyTable( 'definition' );
        }
        await restoreAllInputsFromIndexDB( "mainDefinationPage", dbNoUpgradeDefination, 'definition' );
        await watchingAllInputs2IndexDB( "mainDefinationPage", dbNoUpgradeDefination, 'definition' );
        await dbNoUpgradeDefination.keySet( 'definition', 'id', proId );
        //Ø¹Ø±Ø¶ Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        document.getElementById( "proId" ).innerText = proId;
        await initMap();
        await setupDataWithOutEvent();

    }

</script>
<style>
    .leaflet-control-attribution {
        font-size: 5px;
        opacity: 0.5;
    }
</style>
<div id="mainDefinationPage">
    <!-- Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ -->
    <h3 id="t_133"></h3>
    <input type="text" id="proName">
    <br><br>
    <!-- Ø¹Ù†ÙˆØ§Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¹Ù…Ù„ -->
    <h3 id="t_140"></h3>
    <br>
    <br>
    <div id="map" style="height: 400px; width: 100%;"></div>
    <label id="posation" style="display: block; margin-top: 10px;"></label>
    <!-- Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ© -->
    <h3 id="t_1258"></h3>
    <select id="kindMoSelect">
        <option disabled selected id="t_1258"></option>
    </select>
    <br>
    <label id="kindMoDisc"></label>
    <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ -->
    <br> <br>
    <h3 id="t_137"></h3>
    <select id="kindFinancialSelect">
        <option disabled selected id="t_1259"></option>
    </select>
    <!-- Ù†ÙˆØ¹ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨  -->
    <br> <br>
    <h3 id="t_139"></h3>
    <select id="kindTaxSelect">
        <option disabled selected id="t_139"></option>
    </select>
    <!-- Ù‚ÙŠÙ…Ù‡ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨  -->
    <div id="div_tax" style="display: none;">
        <br> <br>
        <h3 id="t_50"></h3>
        <input type="number" id="taxValuePercentage">
    </div>
    <!-- ÙˆØµÙ Ø§Ù„Ø¹Ù…Ù„  -->
    <br> <br>
    <h3 id="t_431"></h3>
    <textarea id="workDescrip"></textarea>
    <!--  Ø±ÙˆØ§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ù…Ù„ÙØ§Øª  -->
    <br> <br>
    <h3 id="t_439"></h3>
    <input type="url" id="filesLink">
    <!--  Ø³Ø¹Ø± ÙƒØ±Ø§Ø³Ø© Ø§Ù„Ø´Ø±ÙˆØ·  -->
    <br> <br>
    <h3 id="t_637"></h3>
    <input type="number" id="documentFee">

    <!--Ù‚ÙŠÙ…Ù‡ Ø§Ù„ØªØ§Ù…ÙŠÙ† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ  -->
    <br> <br>
    <h3 id="t_440"></h3>
    <input type="number" id="initialGuaranteeValue">

    <!--Ù†Ø³Ø¨Ø© Ø§Ù„ØªØ§Ù…ÙŠÙ† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ  -->
    <br> <br>
    <h3 id="t_1072"></h3>
    <input type="number" id="finalGuaranteeValue">





    <!-- Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ -->
    <br><br>
    <h3 id="t_615"></h3>
    <label id="proId">
</div>

<script>

    //#region Ø§Ù„Ø®Ø±Ø§Ø¦Ø·
    let map, marker, clickCount = 0, position_ = null, clickTimeout = null;
    const PROPHET_MOSQUE_COORDS = [ 24.4672, 39.6117 ];
    async function initMap ()
    {


        if ( map )
        {
            map.remove();
        }
        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        position_ = await dbNoUpgradeDefination.keyGet( 'definition', 'position' );
        const positionLabel = document.getElementById( 'posation' );

        if ( position_ )
        {
            const [ lat, lng ] = position_.split( ',' ).map( Number );
            position_ = [ lat, lng ];
            map = L.map( 'map' ).setView( position_, 10 );
            marker = L.marker( position_ ).addTo( map ); // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© ÙÙŠ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸
            if ( positionLabel )
            {
                positionLabel.textContent = `ğŸ“ Latitude: ${ lat }, Longitude: ${ lng }`;
            }
        } else
        {
            map = L.map( 'map' ).setView( PROPHET_MOSQUE_COORDS, 10 );
        }

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        L.tileLayer( 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        } ).addTo( map );

        // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù†Ù‚Ø±Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        map.on( 'click', async function ( e )
        {
            clickCount++;
            if ( clickCount === 1 )
            {
                clickTimeout = setTimeout( () => clickCount = 0, 300 );
            } else if ( clickCount === 2 )
            {
                clearTimeout( clickTimeout );
                clickCount = 0;

                const latlng = [ e.latlng.lat, e.latlng.lng ];

                if ( marker ) map.removeLayer( marker );
                marker = L.marker( latlng ).addTo( map );

                position_ = `${ latlng[ 0 ].toFixed( 5 ) },${ latlng[ 1 ].toFixed( 5 ) }`;
                if ( positionLabel )
                {
                    positionLabel.textContent = `ğŸ“ Latitude: ${ latlng[ 0 ].toFixed( 5 ) }, Longitude: ${ latlng[ 1 ].toFixed( 5 ) }`;
                }

                await dbNoUpgradeDefination.keySet( 'definition', 'position', position_ );
                map.setView( latlng, 15 );
            }
        } );
    }
    //#endregion

    //#region Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØªØ³Ø¬Ù„Ø© ÙÙŠ Ø§Ù…Ø§ÙƒÙ† Ø§Ø®Ø±ÙŠ
    const inputElement = document.getElementById( 'proName' );

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    inputElement.addEventListener( 'input', async function ( event )
    {
        const currentValue = event.target.value;
        let dbNoUpgrade_ = await new noUpgrade( 'allPro' );
        await dbNoUpgrade_.keySet( proId.replace('def_', ''), 'projectName', currentValue );
    } );
    
    //#endregion

    //#region Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ù†Ø§Ù‚ØµØ©
   function populateKindMoSelect ()
   {
       const select = document.getElementById( "kindMoSelect" );

       for ( let cIndex = 1; cIndex <= 40; cIndex++ )
       {
           const name = getKindTenderValueByCIndex( cIndex, langSelectList0 );
           if ( name )
           {
               const option = document.createElement( "option" );
               option.value = cIndex;
                option.textContent = name;
                select.appendChild( option );
            }
        }
    }
    populateKindMoSelect();
    //#endregion

    //#region Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ
    

    function projectKindFinancialSelect ()
    {
        const select = document.getElementById( "kindFinancialSelect" );

        for ( let cIndex = 0; cIndex <= 10; cIndex++ )
        {
            const name = getKindFinancialByCIndex( cIndex, langSelectList0 );
            if ( name )
            {
                const option = document.createElement( "option" );
                option.value = cIndex;
                option.textContent = name;
                select.appendChild( option );
            }
        }
    }
    projectKindFinancialSelect();
    //#endregion

    //#region Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¶Ø±Ø§Ø¦Ø¨

    function populateTaxSelect ()
    {
        const select = document.getElementById( "kindTaxSelect" );

        for ( let cIndex = 0; cIndex <= 2; cIndex++ )
        {
            const name = getKindTaxByCIndex( cIndex, langSelectList0 );
            if ( name )
            {
                const option = document.createElement( "option" );
                option.value = cIndex;
                option.textContent = name;
                select.appendChild( option );
            }
        }
    }
    populateTaxSelect();
    //#endregion

    //#region Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ÙŠ ØªØºÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„

    // Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø«

    async function setupDefinationData ()
    {
        try
        {
            let kindMoSelect = await dbNoUpgradeDefination.keyGet( 'definition', 'kindMoSelect' );
            document.getElementById( "kindMoDisc" ).innerText = getKindTenderValueByCIndex( kindMoSelect, langSelectList1 ) + " " + getKindTenderValueByCIndex( kindMoSelect, langSelectList2 );

            let taxSelect = await dbNoUpgradeDefination.keyGet( 'definition', 'kindTaxSelect' );

            if ( taxSelect == '0' )
            {
                document.getElementById( "div_tax" ).style.display = '';
            } else
            {
                document.getElementById( "div_tax" ).style.display = 'none';
                document.getElementById( "taxValuePercentage" ).value = '';

                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø¯Ø« 
                isTableWatcherEnabled = false;
                await dbNoUpgradeDefination.keySet( 'definition', 'taxValuePercentage', '' );
            }
        } catch ( er ) { console.error( er ); }
        finally
        {
            // Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø«
            isTableWatcherEnabled = true;
        }
    }
    

    async function setupDataWithOutEvent ()
    {

        let kindMoSelect = await dbNoUpgradeDefination.keyGet( 'definition', 'kindMoSelect' );
        document.getElementById( "kindMoDisc" ).innerText = getKindTenderValueByCIndex( kindMoSelect, langSelectList1 ) + " " + getKindTenderValueByCIndex( kindMoSelect, langSelectList2 );

        let taxSelect = await dbNoUpgradeDefination.keyGet( 'definition', 'kindTaxSelect' );

        if ( taxSelect == '0' )
        {
            document.getElementById( "div_tax" ).style.display = '';
        } else
        {
            document.getElementById( "div_tax" ).style.display = 'none';
            document.getElementById( "taxValuePercentage" ).value = '';

            await dbNoUpgradeDefination.keySet( 'definition', 'taxValuePercentage', '' );
        }

    }

    //#endregion

</script>
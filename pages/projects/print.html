<select id="actionSelector" onchange="handleSelection(this.value)">
    <option value="">-- Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© --</option>
    <option id="t_1276" value="1"></option>
    <option id="t_481" value="2"></option>
    <option value="3">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</option>
</select>
<br>
<br>
<button onclick="ExcelExporter.exportToExcel('table1', 'Ù…Ù„ÙÙŠ.xlsx');">ğŸ“¥ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ Excel</button>
<!-- ğŸ”˜ Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF -->
<button onclick="TablePrinter.printTable('table1', '');">
    Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ù…ØªØµÙØ­
</button>
<br>
<br>
<div id="tablePrintContaner">

</div>










<script>
    let allProcessData = null;
    const pandRaqm = getLang( 762 );
    const pandDiscription = getLang( 906 );
    const pandUnit = getLang( 48 );
    const Quantity = getLang( 38 );
    const Price = getLang( 39 );
    const Total = getLang( 40 );
    //Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    async function initPrintPage ()
    {
        await waitMes();
        allProcessData = await getSingleProcessData( selectedProject );
        if ( allProcessData )
        {
            console.log( allProcessData );
        }
        Swal.close();
    }
    //Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø§Ù…Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
    async function handleSelection ( value )
    {
        switch ( value )
        {
            case "1":
                const res = await estimateOperations.execute();
                TableRenderer.renderTable( res, [ pandRaqm, pandDiscription, pandUnit, Quantity, Price, Total ], 'Estimate', useArabic );

                break;
            case "2":
  const res_ = await awardOperations.execute();
                TableRenderer.renderTable( res_, [ pandRaqm, pandDiscription, pandUnit, Quantity, Price, Total ], 'Estimate', useArabic );

                break;
            case "3":

                break;
            default:
                console.log( "â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ÙŠØ§Ø± Ù…Ø­Ø¯Ø¯" );
        }
    }

    //Ø§Ù…Ø± Ø·Ø¨Ø§Ø¹Ù‡ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
    const estimateOperations = {
        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        getEstimateData: async function ()
        {
            let sumation = 0; // Local variable for this operation

            const result = await Promise.all(
                allProcessData.items.map( async ( item ) =>
                {
                    try
                    {
                        const db = new noUpgrade( 'ite_' + selectedProject );
                        const rows = await db.getAllDataFromTable( item );
                        const entry = Object.fromEntries( rows.map( ( { key, value } ) => [ key, value ] ) );

                        sumation += Number( entry.tot ) || 0;

                        return {
                            numbering: entry.numbering || '',
                            pandText: entry.pandText || '',
                            UnitPand: getUnitByCIndex( entry.UnitPand, langSelectList0 ) || '',
                            kmia: Number( entry.kmia ) || 0,
                            sear: Number( entry.sear ) || 0,
                            tot: Number( entry.tot ) || 0
                        };
                    } catch ( err )
                    {
                        console.error( `âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª ${ item }:`, err );
                        return null;
                    }
                } )
            );

            return {
                list: result.filter( Boolean ),
                total: sumation
            };
        },

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯
        addEstimateItem: function ( estimateList, newItem )
        {
            if ( !newItem || typeof newItem !== 'object' )
            {
                console.warn( "âš ï¸ Ø¹Ù†ØµØ± ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¶Ø§ÙØ©:", newItem );
                return estimateList;
            }

            const requiredKeys = [ 'numbering', 'pandText', 'UnitPand', 'kmia', 'sear', 'tot' ];
            const hasAllKeys = requiredKeys.every( key => key in newItem );

            if ( !hasAllKeys )
            {
                console.warn( "âš ï¸ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:", newItem );
                return estimateList;
            }

            // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ø±Ù‚Ø§Ù… ÙØ¹Ù„ÙŠØ©
            newItem.kmia = Number( newItem.kmia ) || 0;
            newItem.sear = Number( newItem.sear ) || 0;
            newItem.tot = Number( newItem.tot ) || 0;

            return [ ...estimateList, newItem ];
        },

        // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - ÙŠÙ…ÙƒÙ† ØªÙ…Ø±ÙŠØ± Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ù…Ø®ØµØµ
        execute: async function ( customNewItem = null )
        {
            const { list: originalList, total } = await this.getEstimateData();

            const defaultItem = {
                numbering: '-',
                pandText: amount2words( total, 50 ),
                UnitPand: '',
                kmia: 0,
                sear: 0,
                tot: total // Use the calculated total
            };

            const newItem = customNewItem || defaultItem;
            const updatedList = this.addEstimateItem( originalList, newItem );

            console.log( "ğŸ“¦ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©:", updatedList );
            return updatedList;
        }
    };



    //Ø§Ù…Ø± Ø·Ø¨Ø§Ø¹Ù‡ Ø§Ù„Ø§Ø³Ù†Ø§Ø¯
    const awardOperations = {
        // Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        getEstimateData: async function ()
        {
            let sumation = 0; // Local variable for this operation

            const result = await Promise.all(
                allProcessData.items.map( async ( item ) =>
                {
                    try
                    {
                        const db = new noUpgrade( 'ite_' + selectedProject );
                        const rows = await db.getAllDataFromTable( item );
                        const entry = Object.fromEntries( rows.map( ( { key, value } ) => [ key, value ] ) );

                        const db_contractor = new noUpgrade( 'contractor' );
                        const rows_contractor = await db_contractor.getAllDataFromTable( item );
                        const entry_contractor = Object.fromEntries( rows_contractor.map( ( { key, value } ) => [ key, value ] ) );

                        sumation += Number( entry_contractor.tot_contractor ) || 0;

                        return {
                            numbering: entry.numbering || '',
                            pandText: entry.pandText || '',
                            UnitPand: getUnitByCIndex( entry.UnitPand, langSelectList0 ) || '',
                            kmia: Number( entry.kmia ) || 0,
                            sear: Number( entry_contractor.sear_contractor ) || 0,
                            tot: Number( entry_contractor.tot_contractor ) || 0
                        };
                    } catch ( err )
                    {
                        console.error( `âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø¨ÙŠØ§Ù†Ø§Øª ${ item }:`, err );
                        return null;
                    }
                } )
            );

            return {
                list: result.filter( Boolean ),
                total: sumation
            };
        },

        // Ø¯Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯
        addEstimateItem: function ( estimateList, newItem )
        {
            if ( !newItem || typeof newItem !== 'object' )
            {
                console.warn( "âš ï¸ Ø¹Ù†ØµØ± ØºÙŠØ± ØµØ§Ù„Ø­ Ù„Ù„Ø¥Ø¶Ø§ÙØ©:", newItem );
                return estimateList;
            }

            const requiredKeys = [ 'numbering', 'pandText', 'UnitPand', 'kmia', 'sear', 'tot' ];
            const hasAllKeys = requiredKeys.every( key => key in newItem );

            if ( !hasAllKeys )
            {
                console.warn( "âš ï¸ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ÙƒÙ„ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:", newItem );
                return estimateList;
            }

            // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø£Ø±Ù‚Ø§Ù… ÙØ¹Ù„ÙŠØ©
            newItem.kmia = Number( newItem.kmia ) || 0;
            newItem.sear = Number( newItem.sear ) || 0;
            newItem.tot = Number( newItem.tot ) || 0;

            return [ ...estimateList, newItem ];
        },

        // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - ÙŠÙ…ÙƒÙ† ØªÙ…Ø±ÙŠØ± Ø¹Ù†ØµØ± Ø¬Ø¯ÙŠØ¯ Ù…Ø®ØµØµ
        execute: async function ( customNewItem = null )
        {
            const { list: originalList, total } = await this.getEstimateData();

            const defaultItem = {
                numbering: '-',
                pandText: amount2words( total, 50 ),
                UnitPand: '',
                kmia: 0,
                sear: 0,
                tot: total // Use the calculated total
            };

            const newItem = customNewItem || defaultItem;
            const updatedList = this.addEstimateItem( originalList, newItem );

            console.log( "ğŸ“¦ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¶Ø§ÙØ©:", updatedList );
            return updatedList;
        }
    };












</script>
<!--- زر إضافة دفعة جديدة --->
<!-- زر لإضافة دفعة جديدة، عند الضغط عليه يتم استدعاء دالة addBill -->
<button onclick="addBill()">
    <img id="i_addBill" alt="addBill" style="width: 20px; height: 20px; vertical-align: middle; margin-left: 5px" />
    <br />
    <span id="t_1268"></span>
    <!-- سيتم تعبئته بنص معرّب -->
</button>
<!-- زر لحذف الدفعة الحالية، عند الضغط عليه يتم استدعاء دالة deletBill -->
<button onclick="deletBill()">
    <img id="i_delet" alt="addBill" style="width: 20px; height: 20px; vertical-align: middle; margin-left: 5px" />
    <br />
    <span id="t_214"></span>
    <!-- سيتم تعبئته بنص معرّب -->
</button>
<!--- حاوية أزرار الدفعات --->
<br /><br />
<div id="buttonsContainer"></div>

<br /><br />

<style>
    /* تخصيص شريط التمرير لحاوية الجدول */
    #billContaner::-webkit-scrollbar {
        height: 10px;
    }

    #billContaner::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 5px;
    }

    #billContaner::-webkit-scrollbar-thumb {
        background: linear-gradient(90deg, #3d3e3f, #3d3e3f);
        border-radius: 5px;
    }

    #billContaner::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(90deg, #040404, #040404);
    }
</style>
<!--- حاوية الجدول --->
<div id="billContaner" style="max-width:100%;overflow-x: scroll;"></div>

<!-- قالب الصفوف المخفية المستخدمة لنسخ صفوف الجدول -->
<div id="PandBillRaw" style="display: none;">
    <table>
        <thead class="hide-text">
            <tr>
                <!-- عناوين الأعمدة (سيتم تعبئتها ديناميكياً) -->
                <th id="t_37"></th>
                <th id="t_413"></th>
                <th id="t_112"></th>
                <th id="t_113"></th>
                <th id="t_114"></th>
                <th id="t_115"></th>
                <th id="t_116"></th>
                <th id="t_907"></th>
                <th id="t_93"></th>
                <th id="t_293"></th>
                <th id="t_861"></th>
                <th id="t_281"></th>
                <th id="t_39"></th>
                <th id="t_104"></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <!-- كل عمود يحتوي على input أو select حسب نوع البيانات -->
                <td>
                    <input id="numbering" readonly type="text" placeholder=""
                        style="outline: none; border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <input id="PandBillText" type="text" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <td>
                    <input id="PandBillNo" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <td>
                    <input id="PandBillLength" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <td>
                    <input id="PandBillWidth" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <td>
                    <input id="PandBillHight" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <td>
                    <input id="PandBillKg" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <td>
                    <select id="PandBillKindSum">
                        <option id="t_401" value="0"></option>
                        <option id="t_118" value="1"></option>
                    </select>
                </td>
                <td>
                    <input id="PandBillSum" readonly type="number" placeholder=""
                        style="outline: none; border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <select id="PandBillStat" disabled>
                        <option id="t_685" value="0"></option>
                        <option id="t_292" value="1"></option>
                    </select>
                </td>
                <td>
                    <select id="PandBillKindWork">
                        <option id="t_226" value="0"></option>
                        <option id="t_227" value="1"></option>
                    </select>
                </td>
                <td>
                    <input id="PandBillPercent" type="number" min="0" max="100" placeholder=""
                        style="outline: none; border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <input id="PandBillPrice" readonly type="number" placeholder=""
                        style="outline: none; border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <input id="PandBillNote" type="text" placeholder=""
                        style="outline: none; border: none; background-color: transparent; color: black;" />
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- جدول النتائج النهائية -->
<div id="results">
    <br><br>
    <table>
        <!-- صفوف النتائج الإجمالية للأعمال والتشوينات -->
        <tr>
            <td><label id="t_925"></label></td>
            <td><input id="TotalWorksAddition" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black;" /></td>
        </tr>
        <tr>
            <td><label id="t_926"></label></td>
            <td><input id="TotalWorksDiscount" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black;" /></td>
        </tr>
        <tr>
            <td><label id="t_929"></label></td>
            <td><input id="TotalWorks" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black;" /></td>
        </tr>
        <tr>
            <td><label id="t_927"></label></td>
            <td><input id="TotalSuppliesAddition" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black;" /></td>
        </tr>
        <tr>
            <td><label id="t_928"></label></td>
            <td><input id="TotalSuppliesDiscount" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black;" /></td>
        </tr>
        <tr>
            <td><label id="t_930"></label></td>
            <td><input id="TotalSupplies" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black;" /></td>
        </tr>
    </table>
    <br><br>
    <table>
        <thead>
            <tr style="text-align: center; vertical-align: middle;">
                <!-- عناوين الأعمدة للجدول التفصيلي -->
                <th id="t_293"></th>
                <th id="t_922"></th>
                <th id="t_39"></th>
                <th id="t_40"></th>
            </tr>
        </thead>
        <!-- صفوف النتائج التفصيلية للأعمال والتشوينات السابقة والحالية -->
        <tr style="text-align: center; vertical-align: middle;">
            <td><label id="t_321"></label></td>
            <td>
                <input id="PreviousWorksValue" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
                <input id="PreviousWorksPercent" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
            </td>
            <td><label id="priceWork"></label></td>
            <td>
                <input id="PreviousWorksTotalCost" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
            </td>
        </tr>
        <tr style="text-align: center; vertical-align: middle;">
            <td><label id="t_320"></label></td>
            <td>
                <input id="CurrentWorksValue" type="number" placeholder=""
                    style="border: 1px solid black; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
                <input id="CurrentWorksPercent" type="number" placeholder=""
                    style="border: 1px solid black; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
            </td>
            <td><label id="priceWork"></label></td>
            <td>
                <input id="CurrentWorksTotalCost" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
            </td>
        </tr>
        <tr style="text-align: center; vertical-align: middle;">
            <td><label id="t_323"></label></td>
            <td>

                <input id="TotalExecutedWorksValue" type="text" readonly placeholder="" style="  max-width: 50px; min-width:  50px; outline: none; border: none; background-color:
                    transparent; color: black;" />
                <input id="TotalExecutedWorksPercent" type="text" readonly placeholder="" style=" max-width: 50px; min-width:  50px; outline: none; border: none; background-color:
                    transparent; color: black;" />

            </td>
            <td><label id="priceWork"></label></td>
            <td>
                <input id="TotalExecutedWorksTotalCost" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />

            </td>
        </tr>
        <tr style="text-align: center; vertical-align: middle;">
            <td><label id="t_920"></label></td>
            <td>
                <input id="PreviousSuppliesValue" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
                <input id="PreviousSuppliesPercent" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />

            </td>
            <td>
                <input id="PreviousSuppliesPrice" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />

            </td>
            <td>
                <input id="PreviousSuppliesTotalCost" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />

            </td>
        </tr>
        <tr style="text-align: center; vertical-align: middle;">
            <td><label id="t_919"></label></td>
            <td>
                <input id="CurrentSuppliesValue" type="number" placeholder=""
                    style=" border: 1px solid black; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
                <input id="CurrentSuppliesPercent" type="number" placeholder=""
                    style=" border: 1px solid black; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
            </td>
            <td>
                <input id="CurrentSuppliesPrice" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
            </td>
            <td>
                <input id="CurrentSuppliesTotalCost" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
            </td>
        </tr>
        <tr style="text-align: center; vertical-align: middle;">
            <td><label id="t_921"></label></td>
            <td>
                <input id="TotalExecutedSuppliesValue" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />
                <input id="TotalExecutedSuppliesPercent" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />

            </td>
            <td>
                <input id="TotalExecutedSuppliesPrice" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />

            </td>
            <td>
                <input id="TotalExecutedSuppliesTotalCost" type="text" readonly placeholder=""
                    style="outline: none; border: none; background-color: transparent; color: black; max-width: 50px; min-width:  50px;" />

            </td>
        </tr>
    </table>
</div>
<script>
    let worksOverPercent = null;
    let suppliesOverPercent = null;
    let stop_changes = false;
    // دالة تنفذ عند تغيير أي من الحقول
    function handleSuppliesValueChange ()
    {
        const value = document.getElementById( "CurrentSuppliesValue" ).value;
        const percent = document.getElementById( "CurrentSuppliesPercent" ).value;

        console.log( "🔄 تم التغيير:" );
        console.log( "✅ الكمية:", value );
        console.log( "✅ النسبة:", percent );

        // يمكنك هنا استدعاء أي دالة أخرى بالحسابات أو التحقق
        // calculateSuppliesPercentprice([...], [...], [...]);
    }

    function handleWorksValueChange ()
    {
        if ( stop_changes == true ) { return; }
        stop_changes = true;
        const value = document.getElementById( "CurrentWorksValue" ).value;
        document.getElementById( "CurrentWorksPercent" ).value = worksOverPercent / value;
        stop_changes = false;
    }
    function handleWorksPercentChange ()
    {
        if ( stop_changes == true ) { return; }
        stop_changes = true;
        const percent = document.getElementById( "CurrentWorksPercent" ).value;
        document.getElementById( "CurrentWorksValue" ).value = worksOverPercent / percent;
        stop_changes = false;
    }
    // ربط الحدثين
    document.getElementById( "CurrentSuppliesValue" ).addEventListener( "input", handleSuppliesValueChange );
    document.getElementById( "CurrentSuppliesPercent" ).addEventListener( "input", handleSuppliesPercentChange );
    document.getElementById( "CurrentWorksValue" ).addEventListener( "input", handleWorksValueChange );
    document.getElementById( "CurrentWorksPercent" ).addEventListener( "input", handleWorksPercentChange );

</script>

<script>

    // 🟡 تعريف المتغيرات العامة - تم نقلها إلى ملف الأدوات

    /**
     * دالة لمسح جميع أزرار الدفعات من الواجهة وإعادة تعيين مجموعة المؤشرات
     */
    function clearAllButtons ()
    {
        // تفريغ الحاوية من الأزرار
        document.getElementById( "buttonsContainer" ).innerHTML = "";
        // إعادة تعيين مجموعة المؤشرات (لمنع تكرار الأزرار)
        buttonShowIndexSet.clear();
    }

    /**
     * دالة إضافة دفعة جديدة عند الضغط على زر "إضافة حصر"
     * تقوم بتهيئة الصفحة ثم إضافة زر جديد للدفعة التالية
     */
    async function addBill ()
    {
        try
        {
            // تهيئة صفحة الحصر (تحميل البيانات السابقة)
            await initPandBillPage();
            // زيادة رقم آخر دفعة
            lastBill += 1;
            // إضافة زر جديد للدفعة التالية
            await addButton( lastBill );
        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "❌ خطأ في addBill:", error );
        }
    }

    /**
     * دالة حذف الدفعة الحالية عند الضغط على زر الحذف
     * تقوم بحذف قاعدة البيانات الخاصة بالدفعة الأخيرة وتفريغ الحاوية
     */
    async function deletBill ()
    {
        try
        {
            // حذف قاعدة بيانات الدفعة الأخيرة
            await deleteDatabase( "bill_" + lastBill + "_" + selectedPandId );
            // مسح جميع الأزرار
            clearAllButtons();
            // إعادة تهيئة الصفحة
            await initPandBillPage();
            // تفريغ حاوية الجدول
            document.getElementById( "billContaner" ).innerHTML = "";
        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "❌ خطأ في deletBill:", error );
        }
    }

    /**
     * دالة تحميل قواعد البيانات السابقة وإظهار أزرارها
     * تقوم بالبحث عن قواعد البيانات حتى 100 دفعة وتضيف الأزرار المقابلة لها
     */
    async function initPandBillPage ()
    {
        try
        {
            lastBill = 0;
            let i = 1;
            // حلقة للبحث عن قواعد البيانات حتى 100 دفعة كحد أقصى
            while ( i <= 1000 )
            {
                // اسم قاعدة البيانات
                const dbName = "bill_" + i + "_" + selectedPandId;
                // التحقق من وجود قاعدة البيانات
                const exists = await checkDatabaseExists( dbName );
                if ( exists )
                {
                    // إضافة زر للدفعة
                    await addButton( i );
                    // تحديث رقم آخر دفعة
                    lastBill = i;
                    i++;
                } else
                {
                    // التوقف إذا لم تكن قاعدة البيانات موجودة
                    break;
                }
            }
        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "❌ خطأ في initPandBillPage:", error );
        }
    }

    /**
     * دالة إنشاء زر جديد يمثل دفعة معينة
     * @param {number} billIndex رقم الدفعة
     */
    async function addButton ( billIndex )
    {
        try
        {
            // التحقق من عدم تكرار الزر
            if ( buttonShowIndexSet.has( billIndex ) )
            {
                return;
            } else
            {
                // تسجيل المؤشر في المجموعة
                buttonShowIndexSet.add( billIndex );
            }

            // إنشاء عنصر الزر
            const button = document.createElement( "button" );
            button.id = "BillB_" + billIndex;
            // عند الضغط على الزر يتم تحميل بيانات الدفعة
            button.onclick = async function ()
            {
                await addPandBillDatabase( billIndex );
            };
            button.style.margin = "5px";

            // إضافة صورة للزر
            const img = document.createElement( "img" );
            img.alt = "Bill";
            img.id = "i_bill";
            img.style.width = "20px";
            img.style.height = "20px";
            img.style.verticalAlign = "middle";
            img.style.marginLeft = "5px";

            button.appendChild( img );
            button.appendChild( document.createElement( "br" ) );

            // إضافة نص معرف الزر
            const span = document.createElement( "span" );
            span.id = "t_1065_" + billIndex;
            button.appendChild( span );

            // إضافة الزر إلى الحاوية
            document.getElementById( "buttonsContainer" ).appendChild( button );

            // تحديث الترجمة والصور
            await setTextAndImage();

            // إضافة رقم الدفعة بجانب الزر
            const spanNum = document.createElement( "span" );
            spanNum.innerText = " " + billIndex;
            button.appendChild( spanNum );

        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "❌ خطأ في addButton:", error );
        }
    }

    // متغير لمنع تكرار تنفيذ دالة addPandBillDatabase في نفس الوقت
    let stopAddPandBillDatabase = false;

    /**
     * دالة إنشاء قاعدة بيانات وجدول لدفعة معينة
     * يتم التنفيذ عند الضغط على أحد الأزرار الخاصة بدفعة معينة
     * @param {number} dataBaseIndex رقم الدفعة
     */
    async function addPandBillDatabase ( dataBaseIndex )
    {
        try
        {
            // إعادة تعيين معرف قاعدة البيانات السابقة
            dataBaseIdForPandBillPrevious = null;
            // منع تكرار التنفيذ
            if ( stopAddPandBillDatabase == true ) { return; }
            stopAddPandBillDatabase = true;
            // تعطيل مراقبة الجدول مؤقتاً
            isTableWatcherEnabled = false;
            // تعيين اسم قاعدة البيانات الحالية
            dataBaseIdForPandBill = "bill_" + dataBaseIndex + "_" + selectedPandId;

            // محاولة حذف الجدول السابق (إن وُجد)
            try
            {
                await PandBillTable.destroyTable();
            } catch ( error )
            {
                // تجاهل الخطأ إذا لم يكن هناك جدول موجود مسبقاً
            }
            let newBillAndGreaThan1 = false;
            // إذا كان رقم الدفعة أكبر من 1، تعيين قاعدة البيانات السابقة
            if ( Number( dataBaseIndex ) > 1 )
            {
                dataBaseIdForPandBillPrevious = "bill_" + ( Number( dataBaseIndex ) - 1 ) + "_" + selectedPandId;
                //تصدير قاعدة البيانات السابقة
                if ( await checkDatabaseExists( dataBaseIdForPandBill ) == false )
                {
                    const backup = await exportEntireDatabase( dataBaseIdForPandBillPrevious );
                    backup.database = dataBaseIdForPandBill;
                    backup.stores.forEach( store =>
                    {
                        store.data.forEach( item =>
                        {
                            if ( item.key === "PandBillStat" )
                            {
                                item.value = "1";
                            }
                        } );
                    } );
                    await importOrUpdateFromJSON( backup );
                    newBillAndGreaThan1 = true;
                }
            }
            // إنشاء كائن قاعدة بيانات بدون ترقية
            dbNoUp_PandBill = await new noUpgrade( dataBaseIdForPandBill );
            if ( Number( dataBaseIndex ) > 1 )
            {
                dbNoUp_PandBillPrevious = await new noUpgrade( dataBaseIdForPandBillPrevious );
            }
            // إذا لم يكن جدول النتائج موجوداً، يتم إنشاؤه
            if ( await dbNoUp_PandBill.isTableExist( "resultsTable" ) == false )
            {
                let dbUp_PandBill = await new upgrade( dataBaseIdForPandBill );
                await dbUp_PandBill.createKeyTable( "resultsTable" );

                dbNoUp_PandBill = await new noUpgrade( dataBaseIdForPandBill );
                if ( Number( dataBaseIndex ) > 1 )
                {
                    dbNoUp_PandBillPrevious = await new noUpgrade( dataBaseIdForPandBillPrevious );
                }
            }
            //#region اضافه الاعمال السابقة
            if ( newBillAndGreaThan1 == true )
            {
                let TotalExecutedWorksValue = await dbNoUp_PandBill.keyGet( 'resultsTable', "TotalExecutedWorksValue" );
                let TotalExecutedWorksPercent = await dbNoUp_PandBill.keyGet( 'resultsTable', "TotalExecutedWorksPercent" );
                let TotalExecutedWorksTotalCost = await dbNoUp_PandBill.keyGet( 'resultsTable', "TotalExecutedWorksTotalCost" );
                await dbNoUp_PandBill.keySet( 'resultsTable', "PreviousWorksValue", TotalExecutedWorksValue );
                await dbNoUp_PandBill.keySet( 'resultsTable', "PreviousWorksPercent", TotalExecutedWorksPercent );
                await dbNoUp_PandBill.keySet( 'resultsTable', "PreviousWorksTotalCost", TotalExecutedWorksTotalCost );
                await dbNoUp_PandBill.keySet( 'resultsTable', "CurrentWorksValue", "" );
                await dbNoUp_PandBill.keySet( 'resultsTable', "CurrentWorksPercent", "" );
                await dbNoUp_PandBill.keySet( 'resultsTable', "CurrentWorksTotalCost", "" );
                //بالنسبة للتشوينات
                let TotalExecutedSuppliesValue = await dbNoUp_PandBill.keyGet( 'resultsTable', "TotalExecutedSuppliesValue" );
                let TotalExecutedSuppliesPercent = await dbNoUp_PandBill.keyGet( 'resultsTable', "TotalExecutedSuppliesPercent" );
                let TotalExecutedSuppliesPrice = await dbNoUp_PandBill.keyGet( 'resultsTable', "TotalExecutedSuppliesPrice" );
                let TotalExecutedSuppliesTotalCost = await dbNoUp_PandBill.keyGet( 'resultsTable', "TotalExecutedSuppliesTotalCost" );
                await dbNoUp_PandBill.keySet( 'resultsTable', "PreviousSuppliesValue", TotalExecutedSuppliesValue );
                await dbNoUp_PandBill.keySet( 'resultsTable', "PreviousSuppliesPercent", TotalExecutedSuppliesPercent );
                await dbNoUp_PandBill.keySet( 'resultsTable', "PreviousSuppliesPrice", TotalExecutedSuppliesPrice );
                await dbNoUp_PandBill.keySet( 'resultsTable', "PreviousSuppliesTotalCost", TotalExecutedSuppliesTotalCost );
                await dbNoUp_PandBill.keySet( 'resultsTable', "CurrentSuppliesValue", "" );
                await dbNoUp_PandBill.keySet( 'resultsTable', "CurrentSuppliesPercent", "" );
                await dbNoUp_PandBill.keySet( 'resultsTable', "CurrentSuppliesPrice", "" );
                await dbNoUp_PandBill.keySet( 'resultsTable', "CurrentSuppliesTotalCost", "" );

            }
            //#endregion

            // إنشاء كائن جديد للجدول مع المعاملات المطلوبة
            PandBillTable = new setTableParameter(
                "billContaner", // حاوية الجدول
                dataBaseIdForPandBill, // اسم قاعدة البيانات
                "PandBillRaw", // قالب الصفوف
                "", // صف بديل (غير مستخدم حالياً)
                true, // إظهار العنوان
                false, // عدم إضافة صف بالنقر
                true, // بدء بصف جديد
                true, // ترقيم الصفوف
                true//عناصر ادخال الارقام تجتوي علي جداول
            );

            // تعيين القيم الافتراضية وتحميل القيم المخزنة
            await initialValues();

        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "❌ خطأ في addPandBillDatabase:", error );
        } finally
        {
            // إعادة تفعيل التنفيذ ومراقبة الجدول
            stopAddPandBillDatabase = false;
            isTableWatcherEnabled = true;
        }
    }

    /**
     * دالة للتحقق إذا كان هناك قيمة رقمية في مصفوفة
     * @param {Array} array مصفوفة القيم
     * @returns {boolean} هل يوجد قيمة رقمية أم لا
     */
    function hasNumericValue ( array )
    {
        return array.some( isNumeric );
    }

    // قائمة الحقول التي تدخل في حساب حاصل الضرب
    let sumList = [
        "PandBillNo",
        "PandBillLength",
        "PandBillWidth",
        "PandBillHight",
        "PandBillKg"
    ];
    // متغير لمنع تكرار تنفيذ دالة calSumBillSection
    let isCalSumBillSectionRunning = false;

    /**
     * دالة لحساب حاصل ضرب القيم في صف معين وتحديث حقل المجموع
     * @param {string} dataName اسم الحقل (غير مستخدم هنا)
     * @param {string} tableId معرف الصف
     */
    async function calSumBillSection ( dataName, tableId )
    {
        try
        {
            // منع تكرار التنفيذ
            if ( isCalSumBillSectionRunning )
            {
                return;
            }

            isCalSumBillSectionRunning = true;
            isTableWatcherEnabled = false;

            // التحقق من صحة معرف الصف
            if ( isValidIdFormat( tableId ) )
            {
                let value = [];
                let valueCheck = [];
                let key = null;
                // جلب القيم من قاعدة البيانات
                for ( let i = 0; i < sumList.length; i++ )
                {
                    key = sumList[ i ];
                    const valueــ = await dbNoUp_PandBill.keyGet( tableId, key );
                    valueCheck.push( valueــ );
                }
                let product = 1;
                // إذا لم توجد أي قيمة رقمية، الناتج صفر
                if ( !hasNumericValue( valueCheck ) )
                {
                    product = 0;
                }
                else
                {
                    // تعويض القيم الفارغة بـ 1
                    for ( let i = 0; i < sumList.length; i++ )
                    {
                        let val = valueCheck[ i ];
                        if ( val == null || val === "" )
                        {
                            val = 1;
                        }
                        value[ i ] = val;
                    }
                    // حساب حاصل الضرب
                    for ( let i = 0; i < value.length; i++ )
                    {
                        product *= Number( value[ i ] );
                    }
                    // إذا كان نوع التجميع خصم، اضرب في -1
                    if ( await dbNoUp_PandBill.keyGet( tableId, 'PandBillKindSum' ) == '1' )
                    {
                        product *= -1;
                    }
                }
                // تحديد حالة عنصر السعر إذا كان قابل للإدخال أم لا
                if ( await dbNoUp_PandBill.keyGet( tableId, 'PandBillKindWork' ) == '0' )
                {
                    await isPriceEdit( tableId, 0 );
                }
                else
                {
                    await isPriceEdit( tableId, 1 );
                }
                // تحديث قيمة المجموع في قاعدة البيانات والعنصر
                await dbNoUp_PandBill.keySet( tableId, "PandBillSum", product );
                const raw_ = document.getElementById( tableId + "_" );
                const tot_ = raw_.querySelector( "#PandBillSum" );
                tot_.value = product;
                // تحديث المجاميع الكلية
                await calSumBill0( dbNoUp_PandBill );
            }

            isTableWatcherEnabled = true;
        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "Error calculating calSumBillSection:", error );
        } finally
        {
            isCalSumBillSectionRunning = false;
            isTableWatcherEnabled = true;
        }
    }

    // متغير لمنع تكرار تنفيذ دالة calSumBill0
    let isCalScalSumBill0Running = false;

    /**
     * دالة لحساب المجاميع الكلية للأعمال والتشوينات وتحديث النتائج في الصفحة
     * @param {object} dbNoUp_PandBill كائن قاعدة البيانات
     */
    async function calSumBill0 ( dbNoUp_PandBill )
    {
        try
        {

            //#region منع تكرار التنفيذ
            if ( isCalScalSumBill0Running )
            {
                return;
            }
            isCalScalSumBill0Running = true;
            //#endregion

            //#region جلب جميع الصفوف من قاعدة البيانات
            let allRows = await dbNoUp_PandBill.getAllDataFromTable( "rows" );
            if ( !Array.isArray( allRows ) )
            {
                return;
            }
            //#endregion

            //#region تعريف مصفوفات لتجميع القيم حسب النوع
            let sumCurrentWorksValue = [];
            let sumCurrentWorksPercent = [];
            let sumTotalWorksAddition = [];
            let sumTotalWorksDiscount = [];

            let sumCurrentSuppliesValue = [];
            let sumCurrentSuppliesPercent = [];
            let sumCurrentSuppliesPrices = [];
            let sumTotalSuppliesAddition = [];
            let sumTotalSuppliesDiscount = [];
            //#endregion

            //#region المرور على كل صف وتجميع القيم حسب النوع والحالة
            for ( const rawId of allRows )
            {
                // إذا كان نوع العمل "تنفيذي"
                if ( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillKindWork" ) == "0" )
                {

                    sumCurrentWorksValue.push( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillSum" ) );
                    sumCurrentWorksPercent.push( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillPercent" ) );
                    // إذا كان نوع التجميع "إضافة"
                    if ( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillKindSum" ) == "0" )
                    {
                        sumTotalWorksAddition.push( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillSum" ) );
                    }
                    else
                    {
                        sumTotalWorksDiscount.push( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillSum" ) );
                    }

                }
                // إذا كان نوع العمل "تشوينات"
                else
                {
                    let PandBillSum = await dbNoUp_PandBill.keyGet( rawId.key, "PandBillSum" );
                    sumCurrentSuppliesValue.push( PandBillSum );
                    sumCurrentSuppliesPercent.push( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillPercent" ) );
                    sumCurrentSuppliesPrices.push( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillPrice" ) );

                    // إذا كان نوع التجميع "إضافة"
                    if ( await dbNoUp_PandBill.keyGet( rawId.key, "PandBillKindSum" ) == "0" )
                    {
                        sumTotalSuppliesAddition.push( PandBillSum );
                    }
                    else
                    {
                        sumTotalSuppliesDiscount.push( PandBillSum );
                    }

                }
            }
            //#endregion

            //#region حساب القيم الكلية والنسب الكلية للأعمال والتشوينات
            //مجموع قيم الاعمال سواء اضافة او خصم
            let sumTotalWorksAddationAndSubtract = sumCurrentWorksValue.reduce( ( acc, val ) => acc + val, 0 );
            //مجموع قيم التشوينات سواء اضافة او خصم
            let sumTotalSuppliesAddationAndSubtract = sumCurrentSuppliesValue.reduce( ( acc, val ) => acc + val, 0 );

            //جلب الاعمال السابقه
            let previousWorkValueSaved = Number( await dbNoUp_PandBill.keyGet( 'resultsTable', "PreviousWorksValue" ) );
            let previousWorkPercentValueSaved = Number( await dbNoUp_PandBill.keyGet( 'resultsTable', "PreviousWorksPercent" ) );
            //جلب التشوينات السابقه
            let previousSuppliesValueSaved = Number( await dbNoUp_PandBill.keyGet( 'resultsTable', "PreviousSuppliesValue" ) );
            let previousSuppliesPercentValueSaved = Number( await dbNoUp_PandBill.keyGet( 'resultsTable', "PreviousSuppliesPercent" ) );
            let previousSuppliesPriceSaved = Number( await dbNoUp_PandBill.keyGet( 'resultsTable', "PreviousSuppliesPrice" ) );

            //طرح الاعمال السابقة من الحالية
            sumCurrentWorksValue.push( previousWorkValueSaved * -1 );
            sumCurrentWorksPercent.push( previousWorkPercentValueSaved );
            //طرح التشوينات السابقة من الحالية
            sumCurrentSuppliesValue.push( previousSuppliesValueSaved * -1 );
            sumCurrentSuppliesPercent.push( previousSuppliesPercentValueSaved );
            sumCurrentSuppliesPrices.push( previousSuppliesPriceSaved );
            //حساب مجموع الاعمال الحالية بعد طرح السابق منها
            const resultWorks = calculateTotalValuPercent( sumCurrentWorksValue, sumCurrentWorksPercent, sumTotalWorksAddationAndSubtract );
            worksOverPercent = resultWorks.totalValue * resultWorks.overallPercent;
            //حساب اجمالي الاعمال السابق بالاضافة الي الحالي
            const totalResultWorks = calculateTotalValuPercent( [ resultWorks.totalValue, previousWorkValueSaved ], [ resultWorks.overallPercent, previousWorkPercentValueSaved ], sumTotalWorksAddationAndSubtract );
            //حساب مجموع الاعمال الحالية بعد طرح السابق منها
            const resultSuplies = calculateSuppliesPercentprice( sumCurrentSuppliesValue, sumCurrentSuppliesPercent, sumCurrentSuppliesPrices );
            suppliesOverPercent = resultSuplies.valueSum * resultSuplies.foundPercent;
            //حساب اجمالي الاعمال السابق بالاضافة الي الحالي
            const totalResultSuplies = calculateSuppliesPercentprice( [ resultSuplies.valueSum, previousSuppliesValueSaved ], [ resultSuplies.foundPercent, previousSuppliesPercentValueSaved ], [ resultSuplies.foundPrice, previousSuppliesPriceSaved ] );

            //#endregion

            //#region  جلب عناصر الصفحة التي سيتم وضع النتائج فيها
            //عناصر قيم الاعمال 
            const TotalWorks = document.getElementById( 'TotalWorks' );
            const TotalWorksAddition = document.getElementById( 'TotalWorksAddition' );
            const TotalWorksDiscount = document.getElementById( 'TotalWorksDiscount' );
            //عناصر نسب الاعمال الحالية 
            const CurrentWorksValue = document.getElementById( 'CurrentWorksValue' );
            const CurrentWorksPercent = document.getElementById( 'CurrentWorksPercent' );
            const CurrentWorksTotalCost = document.getElementById( 'CurrentWorksTotalCost' );
            //عناصر نسب الاعمال الكلية 
            const TotalExecutedWorksValue = document.getElementById( 'TotalExecutedWorksValue' );
            const TotalExecutedWorksPercent = document.getElementById( 'TotalExecutedWorksPercent' );
            const TotalExecutedWorksTotalCost = document.getElementById( 'TotalExecutedWorksTotalCost' );
            //عناصر قيم التشوينات 
            const TotalSupplies = document.getElementById( 'TotalSupplies' );
            const TotalSuppliesAddition = document.getElementById( 'TotalSuppliesAddition' );
            const TotalSuppliesDiscount = document.getElementById( 'TotalSuppliesDiscount' );
            //عناصر نسب التشوينات الحالية 
            const CurrentSuppliesValue = document.getElementById( 'CurrentSuppliesValue' );
            const CurrentSuppliesPercent = document.getElementById( 'CurrentSuppliesPercent' );
            const CurrentSuppliesPrice = document.getElementById( 'CurrentSuppliesPrice' );
            const CurrentSuppliesTotalCost = document.getElementById( 'CurrentSuppliesTotalCost' );
            //عناصر نسب التشوينات الكلية 
            const TotalExecutedSuppliesValue = document.getElementById( 'TotalExecutedSuppliesValue' );
            const TotalExecutedSuppliesPercent = document.getElementById( 'TotalExecutedSuppliesPercent' );
            const TotalExecutedSuppliesPrice = document.getElementById( 'TotalExecutedSuppliesPrice' );
            const TotalExecutedSuppliesTotalCost = document.getElementById( 'TotalExecutedSuppliesTotalCost' );

            //#endregion

            //#region وضع القيم في العناصر

            CurrentWorksValue.value = resultWorks.totalValue;
            CurrentWorksPercent.value = ( resultWorks.overallPercent );
            CurrentWorksTotalCost.value = ( ( resultWorks.overallPercent / 100 ) * resultWorks.totalValue * Number( pandPrice ) );
            //مجموع الاعمال الحاليه والسابقة
            TotalExecutedWorksValue.value = totalResultWorks.totalValue;
            TotalExecutedWorksPercent.value = ( totalResultWorks.overallPercent );
            TotalExecutedWorksTotalCost.value = ( ( totalResultWorks.overallPercent / 100 ) * totalResultWorks.totalValue * Number( pandPrice ) );

            TotalWorks.value = sumTotalWorksAddationAndSubtract;
            TotalWorksAddition.value = sumTotalWorksAddition.reduce( ( acc, val ) => acc + val, 0 );
            TotalWorksDiscount.value = sumTotalWorksDiscount.reduce( ( acc, val ) => acc + val, 0 );

            TotalSupplies.value = sumTotalSuppliesAddationAndSubtract;
            TotalSuppliesAddition.value = sumTotalSuppliesAddition.reduce( ( acc, val ) => acc + val, 0 );
            TotalSuppliesDiscount.value = sumTotalSuppliesDiscount.reduce( ( acc, val ) => acc + val, 0 );

            CurrentSuppliesValue.value = Number( resultSuplies.valueSum );
            CurrentSuppliesPercent.value = Number( resultSuplies.foundPercent );
            CurrentSuppliesPrice.value = Number( resultSuplies.foundPrice );
            CurrentSuppliesTotalCost.value = ( ( Number( resultSuplies.foundPercent ) / 100 ) * Number( resultSuplies.valueSum ) * Number( resultSuplies.foundPrice ) );

            TotalExecutedSuppliesValue.value = ( totalResultSuplies.valueSum );
            TotalExecutedSuppliesPercent.value = ( totalResultSuplies.foundPercent );
            TotalExecutedSuppliesPrice.value = Number( totalResultSuplies.foundPrice );
            TotalExecutedSuppliesTotalCost.value = ( ( totalResultSuplies.foundPercent / 100 ) * totalResultSuplies.valueSum * Number( totalResultSuplies.foundPrice ) );

            //#endregion

            //#region إطلاق حدث التغيير يدويًا لكي يتم الحفظ
            const inputEvent = new Event( 'input', { bubbles: true } );
            //احداث قيم الاعمال
            TotalWorks.dispatchEvent( inputEvent );
            TotalWorksAddition.dispatchEvent( inputEvent );
            TotalWorksDiscount.dispatchEvent( inputEvent );
            //احداث نسب الاعمال الحالية
            CurrentWorksValue.dispatchEvent( inputEvent );
            CurrentWorksPercent.dispatchEvent( inputEvent );
            CurrentWorksTotalCost.dispatchEvent( inputEvent );
            //احداث قيم التشوينات
            TotalSupplies.dispatchEvent( inputEvent );
            TotalSuppliesAddition.dispatchEvent( inputEvent );
            TotalSuppliesDiscount.dispatchEvent( inputEvent );
            //احداث نسب التشوينات الحالية
            CurrentSuppliesValue.dispatchEvent( inputEvent );
            CurrentSuppliesPercent.dispatchEvent( inputEvent );
            CurrentSuppliesPrice.dispatchEvent( inputEvent );
            CurrentSuppliesTotalCost.dispatchEvent( inputEvent );
            //احداث نسب الاعمال الكلية
            TotalExecutedWorksValue.dispatchEvent( inputEvent );
            TotalExecutedWorksPercent.dispatchEvent( inputEvent );
            TotalExecutedWorksTotalCost.dispatchEvent( inputEvent );
            //احداث نسب التشوينات الكلية
            TotalExecutedSuppliesValue.dispatchEvent( inputEvent );
            TotalExecutedSuppliesPercent.dispatchEvent( inputEvent );
            TotalExecutedSuppliesPrice.dispatchEvent( inputEvent );
            TotalExecutedSuppliesTotalCost.dispatchEvent( inputEvent );

            //#endregion

        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "Error calculating calSumBill0: ", error );
        } finally
        {
            isCalScalSumBill0Running = false;
        }
    }

    /**
  * دالة لحساب القيمة الكلية والنسبة الكلية من مصفوفتين
  * @param {Array} values مصفوفة القيم
  * @param {Array} percentages مصفوفة النسب (0-100)
  * @param {number} referenceTotalValue (اختياري) قيمة مرجعية لإعادة احتساب النسبة
  * @returns {object} كائن يحتوي على القيمة الكلية والنسبة الكلية
  */
    function calculateTotalValuPercent ( values, percentages, referenceTotalValue = 0 )
    {
        try
        {
            let sumUsedValues = 0;
            let weightedSum = 0;

            for ( let i = 0; i < values.length; i++ )
            {
                const val = Number( values[ i ] );
                const pct = Number( percentages[ i ] ) / 100;

                if ( isNaN( val ) || isNaN( pct ) ) continue;

                sumUsedValues += val;
                weightedSum += val * pct;
            }

            let overallPercent = sumUsedValues !== 0
                ? ( weightedSum / sumUsedValues ) * 100
                : 0;

            if ( referenceTotalValue !== 0 )
            {
                const finalValue = sumUsedValues * ( overallPercent / 100 );
                overallPercent = ( finalValue / referenceTotalValue ) * 100;
                sumUsedValues = referenceTotalValue;
            }

            return {
                totalValue: Number( sumUsedValues ),
                overallPercent: Number( overallPercent )
            };
        } catch ( error )
        {
            console.log( '❌ خطأ في calculateTotalValueAndPercent:', error );
            return {
                totalValue: 0,
                overallPercent: 0
            };
        }
    }

    function calculateSuppliesPercentprice ( values, percents, prices )
    {
        if ( values.length !== percents.length || values.length !== prices.length )
        {
            throw new Error( "❌ جميع المصفوفات يجب أن تكون بطول متساوٍ." );
        }
        const cleanValues = [];
        const cleanPercents = [];
        const cleanPrices = [];

        for ( let i = 0; i < values.length; i++ )
        {
            const value = values[ i ];
            const percent = percents[ i ];
            const price = prices[ i ];

            if ( isNumeric( value ) && isNumeric( percent ) && isNumeric( price ) )
            {
                cleanValues.push( value );
                cleanPercents.push( percent );
                cleanPrices.push( price );
            }
        }
        values = cleanValues;
        percents = cleanPercents;
        prices = cleanPrices;
        let totalSum = 0;
        let approvedValueSum = 0;
        let weightedPriceSum = 0;
        let approvedWeights = 0;

        for ( let i = 0; i < values.length; i++ )
        {
            const value = values[ i ];
            const percent = percents[ i ];
            const price = prices[ i ];

            const approvedValue = value * ( percent / 100 );
            totalSum += approvedValue * price;
            approvedValueSum += approvedValue;

            // نستخدم approvedValue بدلاً من value لحساب السعر المرجح
            weightedPriceSum += price * approvedValue;
            approvedWeights += approvedValue;
        }

        if ( approvedValueSum === 0 )
        {
            console.log( "⚠️ مجموع الكميات المعتمدة (بعد ضربها بالنسب) يساوي صفر، لا يمكن إتمام الحسابات." );
        }

        const foundPrice = weightedPriceSum / approvedWeights;
        const foundPercent = 100; // لأننا نستخدم السعر المرجح بناءً على الكميات المعتمدة مباشرة
        const checkTotal = foundPrice * approvedValueSum;

        return {
            totalSum: Number( totalSum ),
            valueSum: Number( approvedValueSum ),
            foundPercent: Number( foundPercent ),
            foundPrice: Number( foundPrice ),
            checkTotal: Number( checkTotal )
        };
    }

    /**
     * دالة لوضع القيم الافتراضية وجلب القيم المخزنة من قاعدة البيانات
     * تقوم بتحديث جميع الحقول في الجدول حسب القيم المخزنة أو تعيين القيم الافتراضية
     */
    let stopInitialValues = false;
    async function initialValues ()
    {
        try
        {
            if ( stopInitialValues == true ) { return; }
            stopInitialValues = true;
            // تعطيل مراقبة الجدول مؤقتاً
            isTableWatcherEnabled = false;

            // تعيين القيم الأساسية
            const maxAttempts = 20;
            let allRows;
            let attempt = 0;

            // محاولة تحميل البيانات من الجدول (بحد أقصى 20 محاولة)
            while ( attempt < maxAttempts )
            {
                allRows = await dbNoUp_PandBill.getAllDataFromTable( "rows" );
                if ( Array.isArray( allRows ) ) break;
                await delay( 100 );
                attempt++;
            }

            if ( !Array.isArray( allRows ) )
            {
                isTableWatcherEnabled = true;
                return;
            }

            // معالجة كل صف من قاعدة البيانات
            for ( const rawId of allRows )
            {
                try
                {
                    if ( !isValidIdFormat( rawId.key ) ) { continue; }


                    await waitForElement( `#${ rawId.key }_` );
                    let rawElement = document.getElementById( rawId.key + "_" );
                    if ( !rawElement ) { continue; }

                    const state = await dbNoUp_PandBill.keyGet( rawId.key, "PandBillStat" );
                    const percent = await dbNoUp_PandBill.keyGet( rawId.key, "PandBillPercent" );
                    const price = await dbNoUp_PandBill.keyGet( rawId.key, "PandBillPrice" );
                    const PandBillKindWork = await dbNoUp_PandBill.keyGet( rawId.key, "PandBillKindWork" );
                    const PandBillKindSum = await dbNoUp_PandBill.keyGet( rawId.key, "PandBillKindSum" );

                    //#region تحديث الحالة إذا كانت غير مطابقة للنص المتوقع
                    if ( state == null || state == "" )
                    {
                        await dbNoUp_PandBill.keySet( rawId.key, "PandBillStat", "0" );
                    }
                    //#endregion

                    // تعيين نسبة افتراضية إذا كانت غير موجودة
                    if ( percent == null || percent === "" )
                    {
                        await dbNoUp_PandBill.keySet( rawId.key, "PandBillPercent", "100" );
                        let PercentElement = rawElement.querySelector( "#PandBillPercent" );
                        PercentElement.value = "100";
                    }

                    // تعيين سعر افتراضي إذا كان غير موجود
                    if ( price == null || price === "" )
                    {
                        await dbNoUp_PandBill.keySet(
                            rawId.key,
                            "PandBillPrice",
                            pandPrice
                        );
                        let PriceElement = rawElement.querySelector( "#PandBillPrice" );
                        PriceElement.value = pandPrice;
                    }

                    //#region تعيين نوع العمل الافتراضي إذا كان غير موجود
                    if ( PandBillKindWork == null || PandBillKindWork === "" )
                    {
                        await dbNoUp_PandBill.keySet(
                            rawId.key,
                            "PandBillKindWork",
                            "0"
                        );
                        await isPriceEdit( rawId.key, 0 );
                        let KindWorkElement = rawElement.querySelector( "#PandBillKindWork" );
                        KindWorkElement.value = "0";
                    }
                    else
                    {
                        if ( PandBillKindWork == "0" )
                        {
                            await isPriceEdit( rawId.key, 0 );
                        } else
                        {
                            await isPriceEdit( rawId.key, 1 );
                        }
                    }
                    //#endregion

                    //#region تعيين نوع التجميع الافتراضي إذا كان غير موجود
                    if ( PandBillKindSum == null || PandBillKindSum === "" )
                    {
                        await dbNoUp_PandBill.keySet(
                            rawId.key,
                            "PandBillKindSum",
                            "0"
                        );
                        let KindSumElement = rawElement.querySelector( "#PandBillKindSum" );
                        KindSumElement.value = "0";
                    }
                    //#endregion

                }
                catch ( error )
                {
                    continue;
                }
            }

            const priceWorks = document.querySelectorAll( '[id="priceWork"]' );
            priceWorks.forEach( ( priceWork ) =>
            {
                priceWork.innerText = pandPrice;
            } );

            // استعادة جميع القيم من قاعدة البيانات إلى الصفحة
            await restoreAllInputsFromIndexDB( "results", dbNoUp_PandBill, 'resultsTable' );
            // مراقبة جميع الحقول وتحديث قاعدة البيانات عند التغيير
            await watchingAllInputs2IndexDB( "results", dbNoUp_PandBill, 'resultsTable' );

        } catch ( error )
        {
            // طباعة الخطأ في وحدة التحكم
            console.error( "🚨 Error in initialValues:", error );
        } finally
        {
            // إعادة تفعيل مراقبة الجدول
            isTableWatcherEnabled = true;
            stopInitialValues = false;
        }
    }

    /**
     * دالة تمكين أو تعطيل إمكانية تعديل حقل السعر في صف الجدول
     * @param {string} tableId معرف الصف الأساسي في الجدول
     * @param {number} state إذا كانت القيمة 1 يجعل الحقل قابل للتعديل، غير ذلك يجعله للقراءة فقط
     */
    async function isPriceEdit ( tableId, state )
    {
        try
        {
            // التحقق من صحة معرف الصف
            if ( !isValidIdFormat( tableId ) ) { return; }

            // الحصول على عنصر الصف من الصفحة باستخدام المعرف
            let rawElement = document.getElementById( tableId + "_" );

            // إذا لم يتم العثور على العنصر، الخروج من الدالة
            if ( !rawElement ) return;

            // البحث عن عنصر حقل السعر داخل الصف
            let priceElement = rawElement.querySelector( "#PandBillPrice" );

            // إذا لم يتم العثور على حقل السعر، الخروج من الدالة
            if ( !priceElement ) return;

            // إذا كانت الحالة 1، اجعل الحقل قابل للتعديل
            if ( state === 1 )
            {
                priceElement.removeAttribute( "readonly" ); // إزالة خاصية القراءة فقط
                priceElement.style.border = "1px solid #234890"; // إضافة إطار أزرق
                priceElement.style.backgroundColor = "#234890"; // تغيير لون الخلفية للأزرق
                priceElement.style.color = "#fff"; // تغيير لون الخط للأبيض ليتناسب مع الخلفية
            } else
            {
                // إذا كانت الحالة غير 1، اجعل الحقل للقراءة فقط
                priceElement.setAttribute( "readonly", true ); // تفعيل خاصية القراءة فقط
                priceElement.style.border = "none"; // إزالة الإطار
                priceElement.style.backgroundColor = "transparent"; // إعادة الخلفية للوضع الافتراضي
                priceElement.style.color = ""; // إعادة لون الخط للوضع الافتراضي
            }
        } catch ( error )
        {
            // في حال حدوث خطأ أثناء التنفيذ، طباعته في وحدة التحكم
            console.error( "Error in isPriceEdit:", error );
        }
    }

</script>
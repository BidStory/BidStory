<!--- زر إضافة دفعة جديدة --->
<button onclick="addBill()">
    <img id="i_addBill" alt="addBill" style="width: 20px; height: 20px; vertical-align: middle; margin-left: 5px" />
    <br />
    <span id="t_1268"></span>
    <!-- سيتم تعبئته بنص معرّب -->
</button>
<button onclick="deletBill()">
    <img id="i_delet" alt="addBill" style="width: 20px; height: 20px; vertical-align: middle; margin-left: 5px" />
    <br />
    <span id="t_214"></span>
    <!-- سيتم تعبئته بنص معرّب -->
</button>
<!--- حاوية أزرار الدفعات --->
<br /><br />
<div id="buttonsContainer"></div>

<br /><br />

<style>
    #billContaner::-webkit-scrollbar {
        height: 5px;
    }

    #billContaner::-webkit-scrollbar-track {
        background: #f0f0f0;
        border-radius: 5px;
    }

    #billContaner::-webkit-scrollbar-thumb {
        background: linear-gradient(90deg, #3d3e3f, #3d3e3f);
        border-radius: 5px;
    }

    #billContaner::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(90deg, #040404, #040404);
    }
</style>
<!--- حاوية الجدول --->
<div id="billContaner" style="max-width:100%;overflow-x: scroll;"></div>

<!-- قالب الصفوف المخفية المستخدمة لنسخ صفوف الجدول -->
<div id="PandBillRaw" style="display: none;">
    <table>
        <thead class="hide-text">
            <tr>
                <th id="t_37"></th>
                <!-- عنوان العمود الأول -->
                <th id="t_413"></th>
                <th id="t_112"></th>
                <th id="t_113"></th>
                <th id="t_114"></th>
                <th id="t_115"></th>
                <th id="t_116"></th>
                <th id="t_907"></th>
                <!--sum1-->
                <th id="t_93"></th>
                <!--state-->
                <th id="t_293"></th>
                <!--type-->
                <th id="t_861"></th>
                <!----percentage-->
                <th id="t_281"></th>
                <!---price-->
                <th id="t_39"></th>
                <!---notes-->
                <th id="t_104"></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <!-- number  -->
                <td>
                    <input id="numbering" readonly type="text" placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
                </td>
                <!-- bill text  -->
                <td>
                    <input id="PandBillText" type="text" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <!-- number of  -->
                <td>
                    <input id="PandBillNo" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <!-- length -->
                <td>
                    <input id="PandBillLength" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <!-- width -->
                <td>
                    <input id="PandBillWidth" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <!-- hight -->
                <td>
                    <input id="PandBillHight" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <!-- kg -->
                <td>
                    <input id="PandBillKg" type="number" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <!-- kind of sum  -->
                <td>
                    <select id="PandBillKindSum">
                        <option id="t_401" value="0"></option>
                        <option id="t_118" value="1"></option>
                    </select>
                </td>
                <!-- sum  -->
                <td>
                    <input id="PandBillSum" readonly type="number" placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
                </td>
                <!-- state  -->
                <td>
                    <input id="PandBillStat" type="text" placeholder=""
                        style="border: none; background-color: transparent; color: black" />
                </td>
                <!-- kind of work   -->
                <td>
                    <select id="PandBillKindWork">
                        <option id="t_226" value="0"></option>
                        <option id="t_227" value="1"></option>
                    </select>
                </td>
                <!-- percentage  -->
                <td>
                    <input id="PandBillPercent" type="number" min="0" max="100" placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
                </td>
                <!-- price  -->
                <td>
                    <input id="PandBillPrice" type="number" placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
                </td>

                <!-- note  -->
                <td>
                    <input id="PandBillNote" type="text" placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
                </td>
            </tr>
        </tbody>
    </table>
</div>

<div id="results">
    <br><br>
    <table>
        <!---احمالي الاضافة للاعمال-->
        <!--Total Works Addition-->
        <tr>
            <td>
                <label id="t_925"></label>

            </td>
            <td>
                <input id="TotalWorksAddition" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
            </td>
        </tr>
        <!---احمالي الخصم للاعمال-->
        <!--Total Works Discount--->
        <tr>
            <td>
                <label id="t_926"></label>

            </td>
            <td>
                <input id="TotalWorksDiscount" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
            </td>
        </tr>
        <!---احمالي للاعمال-->
        <!--Total Works--->
        <tr>
            <td>
                <label id="t_929"></label>

            </td>
            <td>
                <input id="TotalWorks" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
            </td>
        </tr>
        <!---احمالي الاضافة للتشوينات-->
        <!---Total Supplies Addition-->
        <tr>
            <td>
                <label id="t_927"></label>

            </td>
            <td>
                <input id="TotalSuppliesAddition" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
            </td>
        </tr>
        <!---احمالي الخصم للتشوينات-->
        <!--Total Supplies Discount--->
        <tr>
            <td>
                <label id="t_928"></label>

            </td>
            <td>
                <input id="TotalSuppliesDiscount" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
            </td>
        </tr>
        <!---احمالي للتشوينات-->
        <!---Total Supplies-->
        <tr>
            <td>
                <label id="t_930"></label>

            </td>
            <td>
                <input id="TotalSupplies" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />
            </td>
        </tr>
    </table>
    <br><br>
    <table>
        <thead>
            <tr style="text-align: center; vertical-align: middle;">
                <!--الحاله-->
                <th id="t_293"></th>
                <!--النسب-->
                <th id="t_922"></th>
                <!--السعر-->
                <th id="t_39"></th>
                <!--الاجمالي-->
                <th id="t_40"></th>
            </tr>
        </thead>
        <!--اجمالي الكمية المنفذة السابقة-->
        <!--Previous Works--->
        <tr style="text-align: center; vertical-align: middle;">
            <td>
                <label id="t_321"></label>
            </td>
            <td>
                <input id="PreviousWorksValue" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
              max-width: 50px;
              min-width:  50px;
            " />
                <input id="PreviousWorksPercent" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
                 max-width: 50px;
              min-width:  50px;
            " />
            </td>
            <td>
                <label id="priceWork"></label>
            </td>
            <td>
                <input id="PreviousWorksTotalCost" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
                 max-width: 50px;
              min-width:  50px;
            " />
            </td>
        </tr>
        <!--اجمالي الكمية المنفذة الحاليه-->
        <!--Current Works--->
        <tr style="text-align: center; vertical-align: middle;">
            <td>
                <label id="t_320"></label>
            </td>
            <td>
                <input id="CurrentWorksValue" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
              max-width: 50px;
              min-width:  50px;
            " />
                <input id="CurrentWorksPercent" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
                 max-width: 50px;
              min-width:  50px;
            " />
            </td>
            <td>
                <label id="priceWork"></label>
            </td>
            <td>
                <input id="CurrentWorksTotalCost" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
                 max-width: 50px;
              min-width:  50px;
            " />
            </td>
        </tr>
        <!--اجمالي الكمية المنفذة-->
        <!--Total Executed Works--->
        <tr style="text-align: center; vertical-align: middle;">
            <td>
                <label id="t_323"></label>
            </td>
            <td>
                <input id="TotalExecutedWorks" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />

            </td>
            <td>
                <label id="priceWork"></label>
            </td>
            <td>

            </td>
        </tr>
        <!--اجمالي التشوينات المنفذة السابقة-->
        <!---Previous Supplies-->
        <tr style="text-align: center; vertical-align: middle;">
            <td>
                <label id="t_920"></label>
            </td>
            <td>
                <input id="PreviousSupplies" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />

            </td>
            <td>

            </td>
            <td>

            </td>
        </tr>
        <!--اجمالي التشوينات المنفذة الحاليه-->
        <!--Current Supplies--->
        <tr style="text-align: center; vertical-align: middle;">
            <td>
                <label id="t_919"></label>
            </td>
            <td>
                <input id="CurrentSuppliesValue" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
              max-width: 50px;
              min-width:  50px;
            " />
                <input id="CurrentSuppliesPercent" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
                 max-width: 50px;
              min-width:  50px;
            " />
            </td>
            <td>

            </td>
            <td>
                <input id="CurrentSuppliesTotalCost" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
                 max-width: 50px;
              min-width:  50px;
            " />
            </td>
        </tr>
        <!--اجمالي التشوينات المنفذة-->
        <!---Total Executed Supplies-->
        <tr style="text-align: center; vertical-align: middle;">
            <td>
                <label id="t_921"></label>
            </td>
            <td>
                <input id="TotalExecutedSupplies" type="text" readonly placeholder="" style="
              outline: none;
              border: none;
              background-color: transparent;
              color: black;
            " />

            </td>
            <td>

            </td>
            <td>

            </td>
        </tr>
    </table>
</div>

<script>
    // 🟡 تعريف المتغيرات العامة - تم نقلها إلى ملف الأدوات

    // ✅ وظيفة مسح جميع أزرار الدفعات
    function clearAllButtons()
    {
        document.getElementById("buttonsContainer").innerHTML = ""; // تفريغ الحاوية
        buttonShowIndexSet.clear(); // إعادة تعيين مجموعة المؤشرات
    }

    // ✅ عند الضغط على زر "إضافة حصر"
    async function addBill()
    {
        try
        {
            await initPandBillPage();
            lastBill += 1; // تهيئة صفحة الحصر
            await addButton(lastBill); // إضافة زر جديد للدفعة التالية
        } catch (error)
        {
            console.error("❌ خطأ في addBill:", error);
        }
    }

    async function deletBill()
    {
        try
        {
            await deleteDatabase("bill_" + lastBill + "_" + selectedPandId);
            clearAllButtons();
            await initPandBillPage();
            document.getElementById("billContaner").innerHTML = ""; // تفريغ الحاوية
        } catch (error)
        {
            console.error("❌ خطأ في addBill:", error);
        }
    }
    // ✅ تحميل قواعد البيانات السابقة وإظهار أزرارها
    async function initPandBillPage()
    {
        try
        {
            lastBill = 0;
            let i = 1;
            while (i <= 100)
            {
                // حد أقصى لتجنب اللوب اللامتناهي
                const dbName = "bill_" + i + "_" + selectedPandId; // اسم قاعدة البيانات
                const exists = await checkDatabaseExists(dbName); // التحقق من وجودها
                if (exists)
                {
                    await addButton(i); // إضافة الزر
                    lastBill = i; // تحديث آخر رقم دفعة
                    i++;
                } else
                {
                    break; // التوقف إذا لم تكن موجودة
                }
            }


        } catch (error)
        {
            console.error("❌ خطأ في initPandBillPage:", error);
        }
    }

    // ✅ إنشاء زر جديد يمثل دفعة معينة
    async function addButton(billIndex)
    {
        try
        {

            if (buttonShowIndexSet.has(billIndex))
            {
                return; // لا تكرار للأزرار
            } else
            {
                buttonShowIndexSet.add(billIndex); // تسجيل المؤشر
            }

            const button = document.createElement("button");
            button.id = "BillB_" + billIndex;
            button.onclick = async function ()
            {
                await addPandBillDatabase(billIndex); // عند الضغط، يتم تحميل بيانات الدفعة
            };
            button.style.margin = "5px"; // تنسيق الزر

            const img = document.createElement("img"); // صورة داخل الزر
            img.alt = "Bill";
            img.id = "i_bill";
            img.style.width = "20px";
            img.style.height = "20px";
            img.style.verticalAlign = "middle";
            img.style.marginLeft = "5px";

            button.appendChild(img);
            button.appendChild(document.createElement("br"));

            const span = document.createElement("span"); // نص معرف الزر
            span.id = "t_1065_" + billIndex;
            button.appendChild(span);

            document.getElementById("buttonsContainer").appendChild(button); // إضافة الزر للواجهة

            await setTextAndImage(); // تحديث الترجمة والصور

            const spanNum = document.createElement("span"); // رقم الدفعة
            spanNum.innerText = " " + billIndex;
            button.appendChild(spanNum);

        } catch (error)
        {
            console.error("❌ خطأ في addButton:", error);
        }
    }
    let stopAddPandBillDatabase = false;

    /*
     ✅ إنشاء قاعدة بيانات وجدول لدفعة معينة
    يتم التنفيذ عن الضغط علي احدي الازرر الخاصه بدفعه معينه
    */
    async function addPandBillDatabase(dataBaseIndex)
    {
        try
        {
            dataBaseIdForPandBillPrevious = null;
            if (stopAddPandBillDatabase == true) { return; }
            stopAddPandBillDatabase = true;
            isTableWatcherEnabled = false;
            dataBaseIdForPandBill = "bill_" + dataBaseIndex + "_" + selectedPandId; // اسم قاعدة البيانات

            // محاولة حذف الجدول السابق (إن وُجد)
            try
            {
                await PandBillTable.destroyTable(); // حذف الجدول الحالي
            } catch (error)
            {
                // تجاهل الخطأ إذا لم يكن هناك جدول موجود مسبقاً
            }

            if (Number(dataBaseIndex) > 1)
            {
                dataBaseIdForPandBillPrevious = "bill_" + (Number(dataBaseIndex) - 1) + "_" + selectedPandId; // اسم قاعدة البيانات
            }
            dbNoUp_PandBill = await new noUpgrade(dataBaseIdForPandBill);
            if (Number(dataBaseIndex) > 1)
            {
                dbNoUp_PandBillPrevious = await new noUpgrade(dataBaseIdForPandBillPrevious);
            }
            if (await dbNoUp_PandBill.isTableExist("resultsTable") == false)
            {
                let dbUp_PandBill = await new upgrade(dataBaseIdForPandBill);
                await dbUp_PandBill.createKeyTable("resultsTable");
                dbNoUp_PandBill = await new noUpgrade(dataBaseIdForPandBill);
                if (Number(dataBaseIndex) > 1)
                {
                    dbNoUp_PandBillPrevious = await new noUpgrade(dataBaseIdForPandBillPrevious);
                }
            }


            // إنشاء كائن جديد للجدول مع المعاملات
            PandBillTable = new setTableParameter(
                "billContaner", // حاوية الجدول
                dataBaseIdForPandBill, // اسم قاعدة البيانات
                "PandBillRaw", // قالب الصفوف
                "", // صف بديل (غير مستخدم حالياً)
                true, // إظهار العنوان
                false, // عدم إضافة صف بالنقر
                true, // بدء بصف جديد
                true // ترقيم الصفوف
            );

            await initialValues();

        } catch (error)
        {
            console.error("❌ خطأ في addPandBillDatabase:", error);
        } finally
        {
            stopAddPandBillDatabase = false;
            isTableWatcherEnabled = true;
        }
    }

    function hasNumericValue(array)
    {
        return array.some(isNumeric);
    }


    let sumList = [
        "PandBillNo",
        "PandBillLength",
        "PandBillWidth",
        "PandBillHight",
        "PandBillKg"
    ];
    let isCalSumBillSectionRunning = false;
    async function calSumBillSection(dataName, tableId)
    {
        try
        {

            if (isCalSumBillSectionRunning)
            {
                return;
            }

            isCalSumBillSectionRunning = true;
            isTableWatcherEnabled = false;
            let dbNoUpgrade_bill = await new noUpgrade(dataName);

            if (isValidIdFormat(tableId))
            {
                let value = [];
                let valueCheck = [];
                let key = null;
                for (let i = 0; i < sumList.length; i++)
                {
                    key = sumList[i];
                    const valueــ = await dbNoUpgrade_bill.keyGet(tableId, key);
                    valueCheck.push(valueــ);
                }
                let product = 1;
                if (!hasNumericValue(valueCheck))
                {
                    product = 0;

                } else
                {

                    for (let i = 0; i < sumList.length; i++)
                    {
                        let val = valueCheck[i];
                        if (val == null || val === "")
                        {
                            val = 1;
                        }
                        value[i] = val;
                    }

                    for (let i = 0; i < value.length; i++)
                    {
                        product *= Number(value[i]);
                    }

                    if (await dbNoUpgrade_bill.keyGet(tableId, 'PandBillKindSum') == '1')
                    {
                        product *= -1;
                    }

                }
                //لتحديد حاله عنصر السعر ان كان قابل للادخال ام لا
                if (await dbNoUpgrade_bill.keyGet(tableId, 'PandBillKindWork') == '0')
                {
                    await isPriceEdit(tableId, 0);
                } else
                {
                    await isPriceEdit(tableId, 1);
                }
                await dbNoUpgrade_bill.keySet(tableId, "PandBillSum", product);
                const raw_ = document.getElementById(tableId + "_");
                const tot_ = raw_.querySelector("#PandBillSum");
                tot_.value = (product).toFixed(DecimalPoint);
                await calSumBill0(dbNoUpgrade_bill);

            }

            isTableWatcherEnabled = true;
        } catch (error)
        {
            console.error("Error calculating calSumBillSection:", error);
        } finally
        {
            isCalSumBillSectionRunning = false;
            isTableWatcherEnabled = true;

        }
    }

    let isCalScalSumBill0Running = false;
    async function calSumBill0(dbNoUpgrade_bill)
    {
        try
        {

            if (isCalScalSumBill0Running)
            {
                return;
            }
            isCalScalSumBill0Running = true;

            let allRows = await dbNoUpgrade_bill.getAllDataFromTable("rows");
            if (!Array.isArray(allRows))
            {
                return;
            }

            //#region جلب التجميعات طبقا للانواع


            let sumCurrentWorksValue = [];
            let sumCurrentWorksPercent = [];
            let sumTotalWorksAddition = [];
            let sumTotalWorksDiscount = [];

            let sumCurrentSuppliesValue = [];
            let sumCurrentSuppliesPercent = [];
            let sumTotalSuppliesAddition = [];
            let sumTotalSuppliesDiscount = [];


            for (const rawId of allRows)
            {
                //اذا كان نوع العمل تنفيذي
                if (await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillKindWork") == "0")
                {
                    //اذا كان نوع العمل جديد
                    if (await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillStat") == getLang(685))
                    {
                        sumCurrentWorksValue.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillSum"));
                        sumCurrentWorksPercent.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillPercent"));
                        //اذا كان نوع التجميع اضافه
                        if (await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillKindSum") == "0")
                        {
                            sumTotalWorksAddition.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillSum"));
                        }
                        else
                        {
                            sumTotalWorksDiscount.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillSum"));
                        }
                    }
                    //اذا كان نوع العمل سابق
                    else
                    {

                    }

                }

                //اذا كان نوع العمل تشوينات
                else
                {
                    //اذا كان نوع العمل جديد
                    if (await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillStat") == getLang(685))
                    {
                        sumCurrentSuppliesValue.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillSum"));
                        sumCurrentSuppliesPercent.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillPercent"));
                        //اذا كان نوع التجميع اضافه
                        if (await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillKindSum") == "0")
                        {
                            sumTotalSuppliesAddition.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillSum"));
                        }
                        else
                        {
                            sumTotalSuppliesDiscount.push(await dbNoUpgrade_bill.keyGet(rawId.key, "PandBillSum"));
                        }
                    }
                }


            }
            //#endregion

            //جلب القيمه الكليه والنسبه الكليه
            const resultWorks = calculateTotalValuPercent(sumCurrentWorksValue, sumCurrentWorksPercent);
            const resultSuplies = calculateTotalValuPercent(sumCurrentSuppliesValue, sumCurrentSuppliesPercent);

            //جلب العناصر التي سوف يحفظ بها النتائج
            const CurrentWorksValue = document.getElementById('CurrentWorksValue');
            const CurrentWorksPercent = document.getElementById('CurrentWorksPercent');
            const CurrentWorksTotalCost = document.getElementById('CurrentWorksTotalCost');
            const TotalWorks = document.getElementById('TotalWorks');
            const TotalWorksAddition = document.getElementById('TotalWorksAddition');
            const TotalWorksDiscount = document.getElementById('TotalWorksDiscount');

            const CurrentSuppliesValue = document.getElementById('CurrentSuppliesValue');
            const CurrentSuppliesPercent = document.getElementById('CurrentSuppliesPercent');
            const CurrentSuppliesTotalCost = document.getElementById('CurrentSuppliesTotalCost');
            const TotalSupplies = document.getElementById('TotalSupplies');
            const TotalSuppliesAddition = document.getElementById("TotalSuppliesAddition");
            const TotalSuppliesDiscount = document.getElementById('TotalSuppliesDiscount');

            //وضع القيم في العناصر
            TotalWorks.value = resultWorks.totalValue;
            CurrentWorksValue.value = resultWorks.totalValue;
            CurrentWorksPercent.value = (resultWorks.overallPercent).toFixed(DecimalPoint);
            CurrentWorksTotalCost.value = ((resultWorks.overallPercent / 100) * resultWorks.totalValue * Number(pandPrice)).toFixed(DecimalPoint);
            TotalWorksAddition.value = sumTotalWorksAddition.reduce((acc, val) => acc + val, 0);
            TotalWorksDiscount.value = sumTotalWorksDiscount.reduce((acc, val) => acc + val, 0);

            TotalSupplies.value = resultSuplies.totalValue;
            CurrentSuppliesValue.value = resultSuplies.totalValue;
            CurrentSuppliesPercent.value = (resultSuplies.overallPercent).toFixed(DecimalPoint);
            CurrentSuppliesTotalCost.value = ((resultSuplies.overallPercent / 100) * resultSuplies.totalValue * Number(pandPrice)).toFixed(DecimalPoint);
            TotalSuppliesAddition.value = sumTotalSuppliesAddition.reduce((acc, val) => acc + val, 0);
            TotalSuppliesDiscount.value = sumTotalSuppliesDiscount.reduce((acc, val) => acc + val, 0);

            //إطلاق حدث التغيير يدويًا لكي يتم الحفظ
            const inputEvent = new Event('input', { bubbles: true });
            //اطلاق
            CurrentWorksValue.dispatchEvent(inputEvent);
            CurrentWorksPercent.dispatchEvent(inputEvent);
            CurrentWorksTotalCost.dispatchEvent(inputEvent);
            TotalWorks.dispatchEvent(inputEvent);
            TotalWorksAddition.dispatchEvent(inputEvent);
            TotalWorksDiscount.dispatchEvent(inputEvent);

            TotalSupplies.dispatchEvent(inputEvent);
            CurrentSuppliesValue.dispatchEvent(inputEvent);
            CurrentSuppliesPercent.dispatchEvent(inputEvent);
            CurrentSuppliesTotalCost.dispatchEvent(inputEvent);
            TotalSuppliesAddition.dispatchEvent(inputEvent);
            TotalSuppliesDiscount.dispatchEvent(inputEvent);
        } catch (error)
        {
            console.error("Error calculating calSumBill0: ", error);
        } finally
        {
            isCalScalSumBill0Running = false;


        }
    }

    function calculateTotalValuPercent(value, percent)
    {
        let totalW = 0;
        let totalValue = 0;

        for (let i = 0; i < value.length; i++)
        {
            const val = Number(value[i]);
            const pct = Number(percent[i]);

            totalW += val * pct;
            totalValue += val;
        }

        const overallPercent = totalValue !== 0 ? totalW / totalValue : 0;

        return {
            totalValue,
            overallPercent
        };
    }

    //لوضع القيم الافتراضيه وجلب القيم المخزنه 
    async function initialValues()
    {
        try
        {
            // #region 🛑 تعطيل مراقبة الجدول مؤقتاً
            isTableWatcherEnabled = false;
            // #endregion

            // #region 🔤 تعيين القيم الأساسية
            const statPrevText = getLang(292);
            const maxAttempts = 20;
            let allRows;
            let attempt = 0;
            // #endregion

            // #region 🔁 محاولة تحميل البيانات من الجدول (بحد أقصى 20 محاولة)
            while (attempt < maxAttempts)
            {
                allRows = await dbNoUp_PandBill.getAllDataFromTable("rows");
                if (Array.isArray(allRows)) break;
                await delay(100);
                attempt++;
            }

            if (!Array.isArray(allRows))
            {
                isTableWatcherEnabled = true;
                return;
            }
            // #endregion

            // #region 🧠 معالجة كل صف من قاعدة البيانات
            for (const rawId of allRows)
            {
                const state = await dbNoUp_PandBill.keyGet(rawId.key, "PandBillStat");
                const percent = await dbNoUp_PandBill.keyGet(rawId.key, "PandBillPercent");
                const price = await dbNoUp_PandBill.keyGet(rawId.key, "PandBillPrice");
                const PandBillKindWork = await dbNoUp_PandBill.keyGet(rawId.key, "PandBillKindWork");
                const PandBillKindSum = await dbNoUp_PandBill.keyGet(rawId.key, "PandBillKindSum");

                // تحديث الحالة إذا كانت غير مطابقة للنص المتوقع
                if (state == null || state === "" || state !== statPrevText)
                {
                    await dbNoUp_PandBill.keySet(rawId.key, "PandBillStat", getLang(685));
                }

                // تعيين نسبة افتراضية إذا كانت غير موجودة
                if (percent == null || percent === "")
                {
                    await dbNoUp_PandBill.keySet(rawId.key, "PandBillPercent", "100");
                }

                // تعيين نسبة افتراضية إذا كانت غير موجودة
                if (price == null || price === "")
                {
                    await dbNoUp_PandBill.keySet(
                        rawId.key,
                        "PandBillPrice",
                        pandPrice
                    );
                }

                if (PandBillKindWork == null || PandBillKindWork === "")
                {
                    await isPriceEdit(rawId.key, 0);
                    await dbNoUp_PandBill.keySet(
                        rawId.key,
                        "PandBillKindWork",
                        "0"
                    );

                }
                else
                {
                    if (PandBillKindWork == "0")
                    {
                        await isPriceEdit(rawId.key, 0);
                    } else
                    {
                        await isPriceEdit(rawId.key, 1);
                    }
                }

                if (PandBillKindSum == null || PandBillKindSum === "")
                {
                    await dbNoUp_PandBill.keySet(
                        rawId.key,
                        "PandBillKindSum",
                        "0"
                    );
                }

            }
            // #endregion

            // #region 🖼️ تحديث القيم داخل عناصر الصفحة

            const priceWorks = document.querySelectorAll('[id="priceWork"]');
            const states = document.querySelectorAll('[id="PandBillStat"]');
            const percents = document.querySelectorAll('[id="PandBillPercent"]');
            const prices = document.querySelectorAll('[id="PandBillPrice"]');
            const PandBillKindWorks = document.querySelectorAll('[id="PandBillKindWork"]');
            const PandBillKindSums = document.querySelectorAll('[id="PandBillKindSum"]');

            priceWorks.forEach((priceWork) =>
            {
                priceWork.innerText = pandPrice;
            });

            states.forEach((state) =>
            {
                if (
                    state.value == null ||
                    state.value === "" ||
                    state.value !== statPrevText
                )
                {
                    state.value = getLang(685);
                }
            });

            percents.forEach((percent) =>
            {
                if (percent.value == null || percent.value === "")
                {
                    percent.value = "100";
                }
            });

            prices.forEach((price) =>
            {
                if (price.value == null || price.value === "")
                {
                    price.value = pandPrice;
                }
            });

            PandBillKindWorks.forEach((PandBillKindWork) =>
            {
                if (PandBillKindWork.value == null || PandBillKindWork.value === "")
                {
                    PandBillKindWork.value = "0";
                }
            });

            PandBillKindSums.forEach((PandBillKindSum) =>
            {
                if (PandBillKindSum.value == null || PandBillKindSum.value === "")
                {
                    PandBillKindSum.value = "0";
                }
            });

            await restoreAllInputsFromIndexDB("results", dbNoUp_PandBill, 'resultsTable');
            await watchingAllInputs2IndexDB("results", dbNoUp_PandBill, 'resultsTable');

            // #endregion

        } catch (error)
        {
            // #region ❌ معالجة الأخطاء
            console.error("🚨 Error in initialValues:", error);
            // #endregion
        } finally
        {
            // #region ✅ إعادة تفعيل مراقبة الجدول
            isTableWatcherEnabled = true;
            // #endregion
        }

    }
    async function isPriceEdit(tableId, state)
    {
        q('raw_99999999999 ' + tableId + ' -<>- ' + state);

        let rawElement = document.getElementById(tableId + "_");

        if (rawElement)
        {

            let priceElement = rawElement.querySelector("#PandBillPrice");

            if (priceElement)
            {
                if (state == 1 || state == "1")
                {
                    priceElement.removeAttribute("readonly");
                    priceElement.style.border = "1px solid #234890"; // لإظهار أن الحقل قابل للتعديل
                    priceElement.style.backgroundColor = "#234890";
                }
                else
                {
                    priceElement.setAttribute("readonly", true);
                    priceElement.style.border = "none"; // إعادة الشكل السابق
                    priceElement.style.backgroundColor = "transparent";
                }
            }
            
        }

    }

</script>
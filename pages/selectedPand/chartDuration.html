<!--- chartDuratiin file  --->
<script>


    let dbNoUp_PandTimeline = null;


    let dataBaseIdForPandTimeline =
        "Timeline_" + localStorage.getItem("selectedPand");

    // تهيئة الجدول
    let PandTimeline = new setTableParameter(
        "timeLineContaner", // ID of the container element
        dataBaseIdForPandTimeline, // Table ID and database name
        "PandTimelineRaw", // ID of the row template to copy
        "", // ID of alternate row to show on click
        true, // Show table header?
        false, // Add alternate div when row is clicked?
        true // Start with new row?
    );


    async function initPandTimelinePage()
    {
        dataBaseIdForPandTimeline =
            "Timeline_" + localStorage.getItem("selectedPand");

        await PandTimeline.destroyTable();

        PandTimeline = new setTableParameter(
            "timeLineContaner", // ID of the container element
            dataBaseIdForPandTimeline, // Table ID and database name
            "PandTimelineRaw", // ID of the row template to copy
            "", // ID of alternate row to show on click
            true, // Show table header?
            false, // Add alternate div when row is clicked?
            true, // Start with new row?
            true // have numbering column?
        );

        dbNoUp_PandTimeline = await new noUpgrade(dataBaseIdForPandTimeline);


    }


    async function calDuration(dataName, tableId)
    {
        try
        {


            isTableWatcherEnabled = false;
            let dbNoUpgrade_pricing = await new noUpgrade(dataName);
            const start_ = await dbNoUpgrade_pricing.keyGet(tableId, "PandTimelineStart");
            const end_ = await dbNoUpgrade_pricing.keyGet(tableId, "PandTimelineEnd");
            if (start_ === null || end_ === null)
            {
                if (isValidIdFormat(tableId))
                {

                    await dbNoUpgrade_pricing.keySet(tableId, "PandTimelineDuration", "");
                    console.warn("start_ or end_ is null, cannot calculate duration.");
                    return;
                }
            }

            const raw_ = document.getElementById(tableId + "_");

            const tot_ = raw_.querySelector("#PandTimelineDuration");

            let s = parseDateTime(start_) || 0;
            let e = parseDateTime(end_) || 0;

            tot_.value = formatDuration(s - e);
            if (isValidIdFormat(tableId))
            {
                await dbNoUpgrade_pricing.keySet(tableId, "PandTimelineDuration", tot_.value);
            }
            isTableWatcherEnabled = true;
        } catch (error)
        {
            console.error("Error calculating duration:", error);
        } finally
        {
            isTableWatcherEnabled = true;
        }
    }

    function drawTimelineChart(periods)
    {
        const ctx = document.getElementById("timelineChart").getContext("2d");
        if (!ctx)
        {
            console.error("❌ لم يتم العثور على عنصر الرسم البياني.");
            return;
        }

        // استخراج المعلومات الأساسية من الفترات
        const labels = periods.map((p) => p.label);
        const startTimes = periods.map((p) => new Date(p.start).getTime());
        const endTimes = periods.map((p) => new Date(p.end).getTime());
        const durations = endTimes.map((end, i) => end - startTimes[i]);

        // تحديد أقل وقت كبداية للمحور
        const minTime = Math.min(...startTimes);

        // إعداد بيانات الرسم باستخدام أشرطة مكدسة
        const data = {
            labels,
            datasets: [
                // جزء فارغ ليدفع الشريط إلى الموقع الصحيح (بداية الفترة)
                {
                    label: "Start Offset",
                    data: startTimes.map((start) => start - minTime),
                    backgroundColor: "rgba(0,0,0,0)", // شفاف
                    stack: "timeline",
                },
                // الشريط الحقيقي يمثل المدة
                {
                    label: "Duration",
                    data: durations,
                    backgroundColor: "rgba(54, 162, 235, 0.7)",
                    borderRadius: 6,
                    stack: "timeline",
                    barThickness: 20,
                },
            ],
        };

        // خيارات المخطط
        const options = {
            indexAxis: "y", // لجعل الأشرطة أفقية
            responsive: true,
            scales: {
                x: {
                    stacked: true,
                    type: "linear",
                    position: "top",
                    ticks: {
                        callback: function (value)
                        {
                            const date = new Date(minTime + value);
                            return date.toLocaleString();
                        },
                    },
                    title: {
                        display: true,
                        text: "الزمن",
                    },
                },
                y: {
                    stacked: true,
                    title: {
                        display: true,
                        text: "الفترات",
                    },
                },
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function (context)
                        {
                            const start = new Date(minTime + startTimes[context.dataIndex] - minTime);
                            const end = new Date(start.getTime() + durations[context.dataIndex]);
                            const durationDays = (durations[context.dataIndex] / (1000 * 60 * 60 * 24)).toFixed(1);
                            return `من: ${start.toLocaleString()} إلى: ${end.toLocaleString()} (المدة: ${durationDays} يومًا)`;
                        },
                    },
                },
                legend: {
                    display: false,
                },
            },
        };

        // حذف الرسم السابق
        if (window.timelineChart && typeof window.timelineChart.destroy === "function")
        {
            window.timelineChart.destroy();
        }

        // رسم المخطط الجديد
        window.timelineChart = new Chart(ctx, {
            type: "bar",
            data,
            options,
        });
    }


    const periods = [
        {
            label: "مرحلة التحليل",
            start: "2025-05-01T09:00",
            end: "2025-05-03T17:00",
        },
        {
            label: "مرحلة التصميم",
            start: "2025-05-04T09:00",
            end: "2025-05-07T16:00",
        },
        {
            label: "مرحلة التطوير",
            start: "2025-05-08T08:00",
            end: "2025-05-15T18:00",
        },
    ];

    async function toggleDurationChart()
    {
        const canvas = document.getElementById('timelineChart');

        if (canvas.style.display === 'none')
        {
            canvas.style.display = 'block';

            drawTimelineChart(periods);

        } else
        {
            canvas.style.display = 'none';
        }
    }



</script>

<div id="timeLineContaner"></div>
<!-- مكان إضافة الجدول -->

<div DivId id="PandTimelineRaw" style="display: none" class="">

    <table>
        <thead class="hide-text">
            <tr>
                <th id="t_37"></th>
                <th id="t_413"></th>
                <th id="t_91"></th>
                <th id="t_92"></th>
                <th id="t_1010"></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>
                    <input id="numbering" readonly type="text" placeholder=""
                        style="outline: none; border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <input id="PandTimelineText" type="text" placeholder=""
                        style="border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <input id="PandTimelineStart" type="datetime-local" placeholder=""
                        style="border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <input id="PandTimelineEnd" type="datetime-local" placeholder=""
                        style="border: none; background-color: transparent; color: black;" />
                </td>
                <td>
                    <input id="PandTimelineDuration" readonly type="text" placeholder=""
                        style="border: none; background-color: transparent; color: black;" />
                </td>
            </tr>
        </tbody>
    </table>

</div>
<br />
<!-- زر إظهار/إخفاء الرسم -->
<button onclick="toggleDurationChart()">
    <img id="i_chartDuration" alt="raw" style="
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-left: 5px;
          " />
    <br />
    <span id="t_141"></span>
</button>

<br />
<canvas id="timelineChart" style="display: none; width: 100%; max-height: 500px;"></canvas>
<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>📦 تصدير واستيراد قواعد بيانات IndexedDB</title>

    <!-- ✅ مكتبة ضغط الملفات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- ✅ مكتبة لحفظ الملفات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- ✅ مكتبة SweetAlert (اختياري للرسائل الجميلة) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="/BidStory/js/dataBase/dbManager.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
            background: #f9f9f9;
            color: #333;
        }

        button,
        input[type="file"] {
            padding: 10px 20px;
            margin: 15px 0;
            font-size: 16px;
        }

        .section {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ddd;
        }
    </style>
</head>

<body>

    <div class="section">
        <h2>📤 تصدير قواعد بيانات</h2>
        <p>اضغط الزر لتصدير عدة قواعد بيانات وحفظها على جهازك:</p>
        <button onclick="exportMultipleDatabasesAndDownload(['db1', 'db2', 'db3'])">
            ⬇️ تصدير القواعد المحددة
        </button>
    </div>

    <div class="section">
        <label for="fileInput">📥 استيراد قواعد بيانات</label>
        <input type="file" accept=".zip" onchange="importMultipleDatabasesFromFile(this.files[0])">
    </div>

    <hr>
    <button onclick="exportAllDatabases()">⬇️ تصدير جميع القواعد تلقائيًا</button>



    <script>


        async function getAllDatabaseNames()
        {
            if (!indexedDB.databases)
            {
                console.warn("❌ المتصفح لا يدعم indexedDB.databases()");
                return [];
            }

            try
            {
                const databases = await indexedDB.databases();
                const names = databases.map(db => db.name).filter(Boolean); // إزالة null
                console.log("📋 أسماء قواعد البيانات:", names);
                return names;
            } catch (err)
            {
                console.error("❌ حدث خطأ أثناء جلب أسماء القواعد:", err);
                return [];
            }
        }

        async function exportAllDatabases()
        {
            const dbNames = await getAllDatabaseNames();
            if (dbNames.length === 0)
            {
                Swal.fire("معلومة", "لا توجد قواعد بيانات للتصدير", "info");
                return;
            }
            exportMultipleDatabasesAndDownload(dbNames);
        }

        // ✅ تصدير قواعد متعددة
        async function exportMultipleDatabasesAndDownload(dbNames)
        {
            console.log("📦 بدء تصدير قواعد البيانات:", dbNames);
            const exportResults = [];

            for (const dbName of dbNames)
            {
                try
                {
                    const exported = await exportEntireDatabase(dbName);
                    exportResults.push(exported);
                    console.log(`✅ تم تصدير القاعدة: ${dbName}`);
                } catch (err)
                {
                    console.error(`❌ فشل في تصدير القاعدة ${dbName}:`, err);
                }
            }

            const finalExport = {
                exported_at: new Date().toISOString(),
                databases: exportResults
            };

            const jsonStr = JSON.stringify(finalExport, null, 2);
            const zip = new JSZip();
            zip.file("databases.json", jsonStr);

            const zipBlob = await zip.generateAsync({ type: "blob" });

            saveAs(zipBlob, `indexeddb_backup_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "_")}.zip`);
            console.log("🎉 تم ضغط وتنزيل القواعد بنجاح.");
        }

        // ✅ استيراد قواعد من ملف ZIP
        async function importMultipleDatabasesFromFile(file)
        {
            try
            {
                console.log("📥 جاري قراءة الملف...");
                const zip = await JSZip.loadAsync(file);
                const fileName = "databases.json";

                if (!zip.files[fileName])
                {
                    throw new Error("❌ ملف 'databases.json' غير موجود داخل الضغط.");
                }

                const jsonStr = await zip.files[fileName].async("string");
                const parsed = JSON.parse(jsonStr);

                if (!parsed.databases || !Array.isArray(parsed.databases))
                {
                    throw new Error("❌ تنسيق الملف غير صحيح.");
                }

                for (const dbExport of parsed.databases)
                {
                    console.log(`⬇️ جاري استيراد القاعدة: ${dbExport.database}`);
                    await importOrUpdateFromJSON(dbExport);
                }

                console.log("🎉 تم استيراد جميع القواعد بنجاح.");
                Swal.fire("نجاح", "تم استيراد جميع قواعد البيانات بنجاح", "success");
            } catch (err)
            {
                console.error("❌ فشل في استيراد الملف:", err);
                Swal.fire("خطأ", "حدث خطأ أثناء استيراد الملف: " + err.message, "error");
            }
        }

        // ⚠️ تأكد من وجود هذه الدوال مسبقًا:
        // exportEntireDatabase(dbName)
        // importOrUpdateFromJSON(json)
    </script>
</body>

</html>
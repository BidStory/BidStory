<script src="/BidStory/js/dataBase/dbManager.js"></script>

<script>
    // ✅ مصفوفات عامة لتجميع البيانات
    const allDatabaseNames = [];              // لتجميع أسماء جميع قواعد البيانات
    const allProcessNames = [];              // لتجميع أسماء كل العمليات (العمليات الرئيسية)
    const itemsPerProcess = {};              // لكل عملية: العناصر التابعة لها
    const dbsPerItem = {};                   // لكل عنصر: قواعد البيانات المرتبطة به

    // ✅ التحقق من وجود قاعدة بيانات ثم إضافتها إلى القائمة العامة
    async function checkAndAddDatabase(dbName) {
        if (await checkDatabaseExists(dbName)) {
            allDatabaseNames.push(dbName);
            return true;
        }
        return false;
    }

    // ✅ جلب كل العمليات من قاعدة بيانات "allPro"
    async function fetchAllProcesses() {
        const dbName = "allPro";
        const processKeys = [];

        if (!(await checkAndAddDatabase(dbName))) return processKeys;

        const db = new noUpgrade(dbName);
        const rows = await db.getAllDataFromTable("rows");

        if (Array.isArray(rows)) {
            for (const row of rows) {
                if (row?.key !== undefined) {
                    processKeys.push(row.key.toString());
                }
            }
        } else {
            console.warn("⚠️ البيانات في allPro غير صالحة:", rows);
        }

        return processKeys;
    }

    // ✅ جلب العناصر (items) المرتبطة بعملية معينة
    async function fetchItemsForProcess(processKey) {
        const items = [];
        const relatedDBs = [];

        const defDB = `def_${processKey}`;
        const iteDB = `ite_${processKey}`;

        if (await checkAndAddDatabase(defDB)) relatedDBs.push(defDB);

        if (await checkAndAddDatabase(iteDB)) {
            relatedDBs.push(iteDB);
            const db = new noUpgrade(iteDB);
            const rows = await db.getAllDataFromTable("rows");

            if (Array.isArray(rows)) {
                for (const row of rows) {
                    if (row?.key !== undefined) {
                        const itemKey = row.key.toString();
                        items.push(itemKey);

                        // ✅ جلب قواعد البيانات الخاصة بالعنصر
                        const itemDBs = await fetchDatabasesForItem(itemKey);
                        relatedDBs.push(...itemDBs);
                    }
                }
            }
        }

        return { items, relatedDBs };
    }

    // ✅ جلب قواعد البيانات المرتبطة بعنصر معين (item)
    async function fetchDatabasesForItem(itemKey) {
        const itemDBs = [];
        const staticSections = [
            "raw", "equipments", "labor", "transport", "other",
            "cond", "files", "Timeline"
        ];

        // ✅ قواعد البيانات الثابتة المرتبطة بالعنصر
        for (const section of staticSections) {
            const dbName = `${section}_${itemKey}`;
            if (await checkAndAddDatabase(dbName)) {
                itemDBs.push(dbName);
            }
        }

        // ✅ قواعد بيانات الفواتير المتكررة (bill_x_itemKey)
        let i = 1;
        while (i <= 1000) {
            const billDB = `bill_${i}_${itemKey}`;
            const exists = await checkDatabaseExists(billDB);
            if (!exists) break;

            allDatabaseNames.push(billDB);
            itemDBs.push(billDB);

            const db = new noUpgrade(billDB);
            const rows = await db.getAllDataFromTable("rows");

            // ✅ قواعد بيانات أقسام كل فاتورة
            if (Array.isArray(rows)) {
                for (const row of rows) {
                    if (row?.key !== undefined) {
                        const billSections = [
                            "PandBillNo", "PandBillLength", "PandBillWidth",
                            "PandBillHight", "PandBillKg", "PandBillPrice", "PandBillPercent"
                        ];
                        for (const section of billSections) {
                            const sectionDB = `${row.key}__n_${section}`;
                            if (await checkAndAddDatabase(sectionDB)) {
                                itemDBs.push(sectionDB);
                            }
                        }
                    }
                }
            }

            i++;
        }

        // ✅ تخزين قواعد البيانات الخاصة بالعنصر
        dbsPerItem[itemKey] = [...itemDBs];

        return itemDBs;
    }

    // ✅ جلب كافة البيانات: عمليات + عناصر + قواعد بيانات
    async function getAllDatabaseStructure() {
        // ✅ تهيئة كل المتغيرات لتكون نظيفة
        allDatabaseNames.length = 0;
        allProcessNames.length = 0;
        Object.keys(itemsPerProcess).forEach(key => delete itemsPerProcess[key]);
        Object.keys(dbsPerItem).forEach(key => delete dbsPerItem[key]);

        const processes = await fetchAllProcesses();

        for (const processKey of processes) {
            allProcessNames.push(processKey);
            const processData = await fetchItemsForProcess(processKey);
            itemsPerProcess[processKey] = processData;
        }

        console.log("✅ قواعد البيانات:", allDatabaseNames);
        console.log("📌 العمليات:", allProcessNames);
        console.log("🧩 العناصر لكل عملية:", itemsPerProcess);
        console.log("📦 قواعد البيانات لكل عنصر:", dbsPerItem);

        return {
            allDatabaseNames: [...allDatabaseNames],
            allProcessNames: [...allProcessNames],
            itemsPerProcess: { ...itemsPerProcess },
            dbsPerItem: { ...dbsPerItem }
        };
    }

    // ✅ جلب بيانات عملية واحدة حسب اسمها
    async function getSingleProcessData(processKey) {
        if (!processKey || typeof processKey !== "string") {
            console.warn("⚠️ يرجى إدخال اسم عملية صالح");
            return null;
        }

        allDatabaseNames.length = 0;

        const result = {
            process: processKey,
            items: [],
            relatedDatabases: [],
            databasesPerItem: {}
        };

        const allProExists = await checkDatabaseExists("allPro");
        if (!allProExists) {
            console.warn("❌ قاعدة البيانات 'allPro' غير موجودة");
            return null;
        }

        // ✅ التأكد من أن العملية موجودة في "allPro"
        const db = new noUpgrade("allPro");
        const rows = await db.getAllDataFromTable("rows");
        const processFound = rows?.some(row => row?.key?.toString() === processKey);
        if (!processFound) {
            console.warn("❌ العملية غير موجودة:", processKey);
            return null;
        }

        // ✅ جلب العناصر وقواعد البيانات المرتبطة
        const data = await fetchItemsForProcess(processKey);
        result.items = data.items;
        result.relatedDatabases = data.relatedDBs;

        for (const item of data.items) {
            result.databasesPerItem[item] = dbsPerItem[item] || [];
        }

        console.log("📍 بيانات العملية:", result);
        return result;
    }

    // ✅ تنفيذ اختبارات تلقائية في حالة الحاجة
    (async () => {
        await getAllDatabaseStructure();                      // اختبار شامل لكل البيانات
      //  await getSingleProcessData("yzQe1750303300564");     // اختبار عملية محددة
    })();
</script>

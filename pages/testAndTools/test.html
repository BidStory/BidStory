<!DOCTYPE html>
<html>

<head>
	<title>Test DBManager</title>
	<script>
		function dbi(dbName) {
			let currentVersion = 1;

			const openDB = async (version) => {
				return new Promise((resolve, reject) => {
					const request = indexedDB.open(dbName, version);
					request.onsuccess = () => resolve(request.result);
					request.onerror = () => reject(request.error);
				});
			};

			const getCurrentVersion = async () => {
				let db;
				try {
					db = await openDB();
					currentVersion = db.version;
					return currentVersion;
				} finally {
					if (db) db.close();
				}
			};

			const isTableExist = async (tableName) => {
				let db;
				try {
					db = await openDB();
					return db.objectStoreNames.contains(tableName);
				} finally {
					if (db) db.close();
				}
			};

			const createIdTable = async () => {
				try {
					const tableExists = await isTableExist('IdTable');

					if (!tableExists) {

						currentVersion = currentVersion + 1;

						const db = await new Promise((resolve, reject) => {
							const request = indexedDB.open(dbName, currentVersion);

							request.onupgradeneeded = (event) => {
								const db = event.target.result;
								const objectStore = db.createObjectStore('IdTable', {
									keyPath: 'id',
									autoIncrement: false
								});
								objectStore.createIndex('value', 'value', { unique: false });
								console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙÙ‡Ø±Ø³ Ø¨Ù†Ø¬Ø§Ø­');
							};

							request.onsuccess = () => resolve(request.result);
							request.onerror = () => reject(request.error);
						});

						db.close();
					} else {
						console.log('â„¹ï¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙÙ‡Ø±Ø³ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„');
					}
				} catch (error) {
					console.error('âŒ Ø®Ø·Ø£:', error);
				}
			};

			const idSet = async (id, value) => {
				let db;
				try {
					db = await openDB();
					const transaction = db.transaction(['IdTable'], 'readwrite');
					const store = transaction.objectStore('IdTable');

					const data = { id, value };
					const request = store.put(data);

					request.onsuccess = () => {
						console.log(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± (id: ${id}, value: ${value}) Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ IdTable`);
					};

					request.onerror = () => {
						console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ØµØ± Ø¥Ù„Ù‰ IdTable:', request.error);
					};

					transaction.oncomplete = () => db.close();
				} catch (error) {
					console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
				}
			};

			const idGet = async (id) => {
				let db;
				try {

					db = await openDB();
					const transaction = db.transaction(['IdTable'], 'readonly');
					const objectStore = transaction.objectStore('IdTable');
					const value = await new Promise((resolve, reject) => {
						const request = objectStore.get(id);

						request.onsuccess = () => {
							if (request.result) {
								console.log('ðŸ” ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…Ø©:', request.result.value);
								resolve(request.result.value);
							} else {
								console.log('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙŠÙ…Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù');
								resolve(null);
							}
						};

						request.onerror = () => {
							console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©:', request.error);
							reject(request.error);
						};
					});

					db.close();
					return value;

				} catch (error) {
					console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…:', error);
					return null;
				}
				finally {
					if (db) { db.close(); }
				}
			};

			const idDelete = async (id) => {
    let db;
    try {
        db = await openDB();
        const transaction = db.transaction(['IdTable'], 'readwrite');
        const store = transaction.objectStore('IdTable');
        const request = store.delete(id);

        request.onsuccess = () => {
            console.log(`ðŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ø°Ùˆ Ø§Ù„Ù…Ø¹Ø±Ù (${id}) Ø¨Ù†Ø¬Ø§Ø­`);
        };

        request.onerror = () => {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±:', request.error);
        };

        transaction.oncomplete = () => db.close();
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±:', error);
    } finally {
        if (db) db.close();
    }
};



const createCustomTable = async (dbName, tableName, columns) => {
	let currentVersion = 1;

	// ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ…Ø¹Ø±ÙØ© Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
	const getDBVersion = () => {
		return new Promise((resolve, reject) => {
			const request = indexedDB.open(dbName);
			request.onsuccess = () => {
				const db = request.result;
				const version = db.version;
				db.close();
				resolve(version);
			};
			request.onerror = () => reject(request.error);
		});
	};

	const createTable = async () => {
		try {
			currentVersion = await getDBVersion();
			currentVersion += 1;

			const request = indexedDB.open(dbName, currentVersion);

			request.onupgradeneeded = (event) => {
				const db = event.target.result;

				if (db.objectStoreNames.contains(tableName)) {
					console.warn('âš ï¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹');
					return;
				}

				// Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ Ø¨Ù…ÙØªØ§Ø­ id ØªÙ„Ù‚Ø§Ø¦ÙŠ
				const store = db.createObjectStore(tableName, {
					keyPath: 'id',
					autoIncrement: true
				});

				// Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
				for (let col of columns) {
					let unique = false;
					let colName = col;

					if (col.endsWith('_not')) {
						unique = true;
						colName = col.replace(/_not$/, '');
					}

					store.createIndex(colName, colName, { unique });
					console.log(`ðŸ“Œ ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¤Ø´Ø± (${colName}) ${unique ? 'ðŸ“› ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªÙƒØ±Ø§Ø±' : ''}`);
				}

				console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ${tableName} Ø¨Ù†Ø¬Ø§Ø­`);
			};

			request.onsuccess = () => {
				request.result.close();
			};

			request.onerror = () => {
				console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØªØ­ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', request.error);
			};

		} catch (error) {
			console.error('âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„:', error);
		}
	};

Ø§ØµÙ†Ø¹ Ø¯Ø§Ù„Ù‡ ØªØ§Ø®Ø° Ø§Ù„Ø¹ÙˆØ§Ù…ÙŠØ¯ Ø¹Ù„ÙŠ Ø´ÙƒÙ„ [columnName1,columnName2,columnName3_not]
Ø§Ùˆ 
[columnName1,columnName2,columnName3]
ÙˆØªÙ†Ø´Ø¦ Ø¬Ø¯ÙˆÙ„ Ø¨Ù‡ Ø¹Ù…ÙˆØ¯ id ÙƒÙ…ÙØªØ§Ø­ Ø±Ø¦ÙŠØ³ÙŠ Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø°ÙŠØ§Ø¯Ø© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø§Ù„Ø§Ø¶Ø§ÙØ© Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…ÙˆØ§Ù…ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø®Ù„Ø© ÙˆÙÙŠ Ø­Ø§Ù„Ù‡ Ø§Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„ÙŠ _not ÙŠÙƒÙˆÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯ ØºÙŠØ± Ù‚Ø§Ø¨Ù„ Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª 












			const getAllDataFromTable = async (tableName) => {
				let db;
				try {

					db = await openDB();

					return new Promise((resolve, reject) => {
						const transaction = db.transaction(tableName, 'readonly');
						const objectStore = transaction.objectStore(tableName);
						const request = objectStore.getAll();

						request.onsuccess = () => {
							resolve(request.result);
						};

						request.onerror = () => {
							reject('âŒ ÙØ´Ù„ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + request.error);
						};
					});

				} catch (error) {
					console.error('âŒ Ø®Ø·Ø£:', error);
					return [];
				} finally {
					if (db) db.close();
				}
			};

			// Return an object with all methods and the currentVersion
			return (async () => {
				await getCurrentVersion();
				return {
					getCurrentVersion,
					isTableExist,
					openDB,
					dbName,
					createIdTable,
					getAllDataFromTable,
					idSet,
					idGet,
					createTable,
					currentVersion // Now exposing currentVersion
				};
			})();
		}
	</script>
</head>

<body>
	<button onclick="openDb()">open data_base</button>
	<button onclick="create_idTable()">create idTable</button>
	<button onclick="getAllDataFromTable0()">getAllDataFromTable</button>
	<button onclick="add2idTable()">add 2 idTable</button>
	<button onclick="getFromIdTable('x1')">get from id table</button>
	<button onclick="create_table()">create table</button>
	<script>
		let db;
		let i = 0;

		async function openDb() {
			db = await dbi('NewDB');
			console.log(db.currentVersion); // Now you can access the currentVersion
			i = 1;
		}

		async function create_idTable() {

			if (i == 0) { console.log("open frist"); return; }
			db.createIdTable();
		}

		async function getAllDataFromTable0() {
			if (i == 0) { console.log("open frist"); return; }
			const data = db.getAllDataFromTable('IdTable');
			console.log(data);
		}

		async function add2idTable() {

			if (i == 0) { console.log("open frist"); return; }
			await db.idSet('x1', 'y1');

		}

		async function getFromIdTable(params) {


			if (i == 0) { console.log("open frist"); return; }
			await db.idGet('x1');

		}

		async function create_table() {
			if (i == 0) { console.log("open frist"); return; }
			await db.createTable('new_table', ['col1', 'col2', 'col3'])
		}

	</script>
</body>

</html>
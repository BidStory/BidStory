<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <title>ğŸ“¦ ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª IndexedDB</title>

    <!-- âœ… Ù…ÙƒØªØ¨Ø© Ø¶ØºØ· Ø§Ù„Ù…Ù„ÙØ§Øª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <!-- âœ… Ù…ÙƒØªØ¨Ø© Ù„Ø­ÙØ¸ Ø§Ù„Ù…Ù„ÙØ§Øª -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <!-- âœ… Ù…ÙƒØªØ¨Ø© SweetAlert (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù…ÙŠÙ„Ø©) -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="/BidStory/js/dataBase/dbManager.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 30px;
            background: #f9f9f9;
            color: #333;
        }

        button,
        input[type="file"] {
            padding: 10px 20px;
            margin: 15px 0;
            font-size: 16px;
        }

        .section {
            background: #fff;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px #ddd;
        }
    </style>
</head>

<body>

    <div class="section">
        <h2>ğŸ“¤ ØªØµØ¯ÙŠØ± Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</h2>
        <p>Ø§Ø¶ØºØ· Ø§Ù„Ø²Ø± Ù„ØªØµØ¯ÙŠØ± Ø¹Ø¯Ø© Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ­ÙØ¸Ù‡Ø§ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ:</p>
        <button onclick="exportMultipleDatabasesAndDownload(['db1', 'db2', 'db3'])">
            â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        </button>
    </div>

    <div class="section">
        <label for="fileInput">ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</label>
        <input type="file" accept=".zip" onchange="importMultipleDatabasesFromFile(this.files[0])">
    </div>

    <hr>
    <button onclick="exportAllDatabases()">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§</button>



    <script>


        async function getAllDatabaseNames()
        {
            if (!indexedDB.databases)
            {
                console.warn("âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… indexedDB.databases()");
                return [];
            }

            try
            {
                const databases = await indexedDB.databases();
                const names = databases.map(db => db.name).filter(Boolean); // Ø¥Ø²Ø§Ù„Ø© null
                console.log("ğŸ“‹ Ø£Ø³Ù…Ø§Ø¡ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", names);
                return names;
            } catch (err)
            {
                console.error("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯:", err);
                return [];
            }
        }

        async function exportAllDatabases()
        {
            const dbNames = await getAllDatabaseNames();
            if (dbNames.length === 0)
            {
                Swal.fire("Ù…Ø¹Ù„ÙˆÙ…Ø©", "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±", "info");
                return;
            }
            exportMultipleDatabasesAndDownload(dbNames);
        }

        // âœ… ØªØµØ¯ÙŠØ± Ù‚ÙˆØ§Ø¹Ø¯ Ù…ØªØ¹Ø¯Ø¯Ø©
        async function exportMultipleDatabasesAndDownload(dbNames)
        {
            console.log("ğŸ“¦ Ø¨Ø¯Ø¡ ØªØµØ¯ÙŠØ± Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", dbNames);
            const exportResults = [];

            for (const dbName of dbNames)
            {
                try
                {
                    const exported = await exportEntireDatabase(dbName);
                    exportResults.push(exported);
                    console.log(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: ${dbName}`);
                } catch (err)
                {
                    console.error(`âŒ ÙØ´Ù„ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© ${dbName}:`, err);
                }
            }

            const finalExport = {
                exported_at: new Date().toISOString(),
                databases: exportResults
            };

            const jsonStr = JSON.stringify(finalExport, null, 2);
            const zip = new JSZip();
            zip.file("databases.json", jsonStr);

            const zipBlob = await zip.generateAsync({ type: "blob" });

            saveAs(zipBlob, `indexeddb_backup_${new Date().toISOString().slice(0, 19).replace(/[:T]/g, "_")}.zip`);
            console.log("ğŸ‰ ØªÙ… Ø¶ØºØ· ÙˆØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
        }

        // âœ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ù† Ù…Ù„Ù ZIP
        async function importMultipleDatabasesFromFile(file)
        {
            try
            {
                console.log("ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù...");
                const zip = await JSZip.loadAsync(file);
                const fileName = "databases.json";

                if (!zip.files[fileName])
                {
                    throw new Error("âŒ Ù…Ù„Ù 'databases.json' ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¶ØºØ·.");
                }

                const jsonStr = await zip.files[fileName].async("string");
                const parsed = JSON.parse(jsonStr);

                if (!parsed.databases || !Array.isArray(parsed.databases))
                {
                    throw new Error("âŒ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± ØµØ­ÙŠØ­.");
                }

                for (const dbExport of parsed.databases)
                {
                    console.log(`â¬‡ï¸ Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: ${dbExport.database}`);
                    await importOrUpdateFromJSON(dbExport);
                }

                console.log("ğŸ‰ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­.");
                Swal.fire("Ù†Ø¬Ø§Ø­", "ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", "success");
            } catch (err)
            {
                console.error("âŒ ÙØ´Ù„ ÙÙŠ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù:", err);
                Swal.fire("Ø®Ø·Ø£", "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù: " + err.message, "error");
            }
        }

        // âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…Ø³Ø¨Ù‚Ù‹Ø§:
        // exportEntireDatabase(dbName)
        // importOrUpdateFromJSON(json)
    </script>
</body>

</html>
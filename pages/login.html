<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>نظام تسجيل المستخدمين</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			max-width: 600px;
			margin: 0 auto;
			padding: 20px;
			background-color: #f5f5f5;
		}

		.container {
			background-color: white;
			padding: 20px;
			border-radius: 8px;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		h1 {
			color: #2c3e50;
			text-align: center;
		}

		.form-group {
			margin-bottom: 15px;
		}

		label {
			display: block;
			margin-bottom: 5px;
			font-weight: bold;
		}

		input[type="text"],
		input[type="password"],
		input[type="email"],
		input[type="file"] {
			width: 100%;
			padding: 8px;
			border: 1px solid #ddd;
			border-radius: 4px;
			box-sizing: border-box;
		}

		.error {
			color: red;
			font-size: 14px;
			margin-top: 5px;
		}

		button {
			background-color: #3498db;
			color: white;
			border: none;
			padding: 10px 15px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			margin-top: 10px;
		}

		button:hover {
			background-color: #2980b9;
		}

		.image-preview {
			max-width: 150px;
			max-height: 150px;
			margin-top: 10px;
			display: none;
		}

		.tabs {
			display: flex;
			margin-bottom: 20px;
		}

		.tab {
			padding: 10px 20px;
			cursor: pointer;
			background-color: #eee;
			margin-left: 5px;
			border-radius: 5px 5px 0 0;
		}

		.tab.active {
			background-color: #3498db;
			color: white;
		}

		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
		}

		#userList {
			margin-top: 20px;
		}

		.user-item {
			border: 1px solid #ddd;
			padding: 10px;
			margin-bottom: 10px;
			border-radius: 4px;
			background-color: white;
		}

		.user-image {
			max-width: 50px;
			max-height: 50px;
			border-radius: 50%;
		}

		.image-options {
			display: flex;
			gap: 10px;
			margin-bottom: 10px;
		}

		.image-options button {
			flex: 1;
			padding: 8px;
			background-color: #3498db;
			color: white;
			border: none;
			border-radius: 4px;
			cursor: pointer;
		}

		.image-options button:hover {
			background-color: #2980b9;
		}

		#cameraContainer {
			margin: 10px 0;
			border: 1px solid #ddd;
			padding: 10px;
			border-radius: 4px;
			background-color: #f9f9f9;
		}

		#cameraPreview {
			display: block;
			margin: 0 auto 10px;
			background-color: #000;
		}

		#captureImage,
		#closeCamera {
			margin: 5px;
			padding: 8px 15px;
		}
	</style>
</head>

<body>

	<div class="container">

		<div class="tabs">

			<div class="tab active" onclick="switchTab('users')">قائمة المستخدمين</div>

			<div class="tab" onclick="switchTab('register')">تسجيل جديد</div>

		</div>

		<div id="users" class="tab-content active">
			<h2>قائمة المستخدمين</h2>
			<div id="userList"></div>
		</div>


		<div id="register" class="tab-content">
			<form id="registrationForm">

				<div class="form-group">
					<label for="username">اسم المستخدم (حد أقصى 20 حرفًا):</label>
					<input type="text" id="username" maxlength="20" required>
					<div id="usernameError" class="error"></div>
				</div>

				<div class="form-group">
					<label for="email">البريد الإلكتروني:</label>
					<input type="email" id="email" required>
					<div id="emailError" class="error"></div>
				</div>

				<div class="form-group">
					<label for="password">كلمة المرور (حد أقصى 7 أحرف):</label>
					<input type="password" id="password" maxlength="7" required>
					<div id="passwordError" class="error"></div>
				</div>

				<div class="form-group">
					<label for="confirmPassword">تأكيد كلمة المرور:</label>
					<input type="password" id="confirmPassword" maxlength="7" required>
					<div id="confirmPasswordError" class="error"></div>
				</div>

				<div class="form-group">
					<label>صورة المستخدم:</label>
					<div class="image-options">
						<button type="button" id="openCamera">فتح الكاميرا</button>
						<button type="button" id="uploadImage">رفع صورة</button>
						<input type="file" id="userImage" accept="image/*" style="display:none;">
					</div>

					<div id="cameraContainer" style="display:none;">
						<video id="cameraPreview" width="300" height="200" autoplay></video>
						<button type="button" id="captureImage">التقاط صورة</button>
						<button type="button" id="closeCamera">إغلاق الكاميرا</button>
					</div>

					<img id="imagePreview" class="image-preview" alt="معاينة الصورة">
				</div>

				<button type="submit">تسجيل</button>
				<button type="button" id="clearForm">مسح النموذج</button>
			</form>
		</div>



	</div>

	<script src="/js/indexedDBManager.js"></script>

	<script>

		// تعريف هيكل قاعدة البيانات
		const dbConfig = {
			dbName: "UsersDB",
			version: 1,
			stores: [
				{
					name: "users",
					keyPath: "email",
					indexes: [
						{ name: "username", keyPath: "username", unique: false }
					]
				}
			]
		};

		// تهيئة قاعدة البيانات
		const dbManager = manageIndexedDB(dbConfig.dbName, dbConfig.version, dbConfig.stores);

		// متغيرات DOM
		const registrationForm = document.getElementById("registrationForm");
		const usernameInput = document.getElementById("username");
		const emailInput = document.getElementById("email");
		const passwordInput = document.getElementById("password");
		const confirmPasswordInput = document.getElementById("confirmPassword");
		const userImageInput = document.getElementById("userImage");
		const imagePreview = document.getElementById("imagePreview");
		const clearFormBtn = document.getElementById("clearForm");
		const userListDiv = document.getElementById("userList");
		const openCameraBtn = document.getElementById("openCamera");
		const uploadImageBtn = document.getElementById("uploadImage");
		const cameraContainer = document.getElementById("cameraContainer");
		const cameraPreview = document.getElementById("cameraPreview");
		const captureImageBtn = document.getElementById("captureImage");
		const closeCameraBtn = document.getElementById("closeCamera");
		let stream = null;

		// فتح الكاميرا
		openCameraBtn.addEventListener("click", async function () {
			try {
				stream = await navigator.mediaDevices.getUserMedia({
					video: { width: 300, height: 200 },
					audio: false
				});
				cameraPreview.srcObject = stream;
				cameraContainer.style.display = "block";
				imagePreview.style.display = "none";
			} catch (error) {
				console.error("خطأ في الوصول للكاميرا:", error);
				alert("لا يمكن الوصول للكاميرا. يرجى التأكد من الصلاحيات");
			}
		});

		// التقاط صورة من الكاميرا
		captureImageBtn.addEventListener("click", function () {
			const canvas = document.createElement("canvas");
			canvas.width = cameraPreview.videoWidth;
			canvas.height = cameraPreview.videoHeight;
			const ctx = canvas.getContext("2d");
			ctx.drawImage(cameraPreview, 0, 0, canvas.width, canvas.height);

			imagePreview.src = canvas.toDataURL("image/png");
			imagePreview.style.display = "block";
			closeCamera();
		});

		// إغلاق الكاميرا
		closeCameraBtn.addEventListener("click", closeCamera);

		function closeCamera() {
			if (stream) {
				stream.getTracks().forEach(track => track.stop());
				stream = null;
			}
			cameraPreview.srcObject = null;
			cameraContainer.style.display = "none";
		}

		// رفع صورة من الجهاز
		uploadImageBtn.addEventListener("click", function () {
			userImageInput.click();
		});

		// معاينة الصورة المرفوعة
		userImageInput.addEventListener("change", function (e) {
			const file = e.target.files[0];
			if (file) {
				const reader = new FileReader();
				reader.onload = function (event) {
					imagePreview.src = event.target.result;
					imagePreview.style.display = "block";
					closeCamera();
				};
				reader.readAsDataURL(file);
			}
		});

		// مسح النموذج
		clearFormBtn.addEventListener("click", function () {
			registrationForm.reset();
			imagePreview.style.display = "none";
			closeCamera();
			clearErrors();
			delete registrationForm.dataset.editing;
			registrationForm.querySelector("button[type='submit']").textContent = "تسجيل";
		});

		// تبديل التبويبات
		function switchTab(tabId) 
		{

			document.querySelectorAll(".tab-content").forEach(tab => {
				tab.classList.remove("active");
			});
			document.querySelectorAll(".tab").forEach(tab => {
				tab.classList.remove("active");
			});

			document.getElementById(tabId).classList.add("active");
			document.querySelector(`.tab[onclick="switchTab('${tabId}')"]`).classList.add("active");

			if (tabId === "users") {
				loadUsers();
			}
			
		}

		// مسح رسائل الخطأ
		function clearErrors() {
			document.querySelectorAll(".error").forEach(el => {
				el.textContent = "";
			});
		}

		// تحقق من صحة البريد الإلكتروني
		function validateEmail(email) {
			const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			return re.test(email);
		}

		// تحميل قائمة المستخدمين
		async function loadUsers() {
			try {
				await dbManager.open();
				const users = await dbManager.getAllRecords("users");

				if (users.length === 0) {
					userListDiv.innerHTML = "<p>لا يوجد مستخدمين مسجلين بعد</p>";
					return;
				}

				userListDiv.innerHTML = "";
				users.forEach(user => {
					const userDiv = document.createElement("div");
					userDiv.className = "user-item";

					let userImage = "";
					if (user.image) {
						userImage = `<img src="${user.image}" class="user-image">`;
					}

					userDiv.innerHTML = `
                        ${userImage}
                        <h3>${user.username}</h3>
                        <p>${user.email}</p>
                        <button onclick="editUser('${user.email}')">تعديل</button>
                        <button onclick="deleteUser('${user.email}')">حذف</button>
                    `;

					userListDiv.appendChild(userDiv);
				});
			} catch (error) {
				console.error("خطأ في تحميل المستخدمين:", error);
				userListDiv.innerHTML = "<p>حدث خطأ أثناء تحميل المستخدمين</p>";
			}
		}

		// تعديل مستخدم
		async function editUser(email) {
			try {
				await dbManager.open();
				const user = await dbManager.getRecord("users", email);

				if (user) {
					usernameInput.value = user.username;
					emailInput.value = user.email;
					passwordInput.value = user.password;
					confirmPasswordInput.value = user.password;

					if (user.image) {
						imagePreview.src = user.image;
						imagePreview.style.display = "block";
					}

					registrationForm.querySelector("button[type='submit']").textContent = "تحديث";
					registrationForm.dataset.editing = email;
					switchTab("register");
				}
			} catch (error) {
				console.error("خطأ في تحميل بيانات المستخدم:", error);
				alert("حدث خطأ أثناء تحميل بيانات المستخدم");
			}
		}

		// حذف مستخدم
		async function deleteUser(email) {
			if (confirm("هل أنت متأكد من حذف هذا المستخدم؟")) {
				try {
					await dbManager.open();
					await dbManager.deleteRecord("users", email);
					loadUsers();
					alert("تم حذف المستخدم بنجاح");
					switchTab('register');
				} catch (error) {
					console.error("خطأ في حذف المستخدم:", error);
					alert("حدث خطأ أثناء حذف المستخدم");
				}
			}
		}

		// معالجة تسجيل/تحديث المستخدم
		registrationForm.addEventListener("submit", async function (e) {
			e.preventDefault();
			closeCamera();
			clearErrors();

			// التحقق من صحة البيانات
			let isValid = true;

			if (usernameInput.value.trim().length === 0) {
				document.getElementById("usernameError").textContent = "اسم المستخدم مطلوب";
				isValid = false;
			} else if (usernameInput.value.trim().length > 20) {
				document.getElementById("usernameError").textContent = "يجب ألا يتجاوز اسم المستخدم 20 حرفًا";
				isValid = false;
			}

			if (emailInput.value.trim().length === 0) {
				document.getElementById("emailError").textContent = "البريد الإلكتروني مطلوب";
				isValid = false;
			} else if (!validateEmail(emailInput.value.trim())) {
				document.getElementById("emailError").textContent = "البريد الإلكتروني غير صالح";
				isValid = false;
			}

			if (passwordInput.value.length === 0) {
				document.getElementById("passwordError").textContent = "كلمة المرور مطلوبة";
				isValid = false;
			} else if (passwordInput.value.length > 7) {
				document.getElementById("passwordError").textContent = "يجب ألا تتجاوز كلمة المرور 7 أحرف";
				isValid = false;
			}

			if (passwordInput.value !== confirmPasswordInput.value) {
				document.getElementById("confirmPasswordError").textContent = "كلمتا المرور غير متطابقتين";
				isValid = false;
			}

			if (!isValid) return;

			// تحضير بيانات المستخدم
			const userData = {
				username: usernameInput.value.trim(),
				email: emailInput.value.trim(),
				password: passwordInput.value,
				image: imagePreview.style.display === "block" ? imagePreview.src : null
			};

			try {
				await dbManager.open();

				if (!registrationForm.dataset.editing) {
					const existingUser = await dbManager.getRecord("users", userData.email);
					if (existingUser) {
						document.getElementById("emailError").textContent = "هذا البريد الإلكتروني مسجل بالفعل";
						return;
					}
				}

				if (registrationForm.dataset.editing) {
					await dbManager.updateRecord("users", userData);
					alert("تم تحديث بيانات المستخدم بنجاح");
				} else {
					await dbManager.addRecord("users", userData);
					alert("تم تسجيل المستخدم بنجاح");
				}

				registrationForm.reset();
				imagePreview.style.display = "none";
				delete registrationForm.dataset.editing;
				registrationForm.querySelector("button[type='submit']").textContent = "تسجيل";
				loadUsers();
				switchTab("users");
			} catch (error) {
				console.error("خطأ في حفظ بيانات المستخدم:", error);
				alert("حدث خطأ أثناء حفظ بيانات المستخدم");
			}
		});

		// تحميل أولي لقائمة المستخدمين عند تحميل الصفحة
		window.addEventListener("load", function () {
			dbManager.open().then(() => {
				loadUsers();
			}).catch(error => {
				console.error("خطأ في فتح قاعدة البيانات:", error);
			});
		});
	</script>

</body>

</html>
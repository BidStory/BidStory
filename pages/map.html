<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>تحديد الموقع</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #map-container {
      width: 25vw;
      height: 25vh;
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    #map-container.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    #exitFullscreen {
      display: none;
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1100;
      padding: 8px 16px;
      background: #3803f7;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      font-size: 16px;
        color: #fff;
    }

   /* تصغير حجم نسبة OpenStreetMap */
.leaflet-control-attribution {
  font-size: 5px; /* أو جرب 8px لو أردته أصغر */
  opacity: 0.5;     /* اجعلها باهتة قليلاً إن أردت */
}

  </style>
</head>
<body>

<div id="map-container">
  <div id="map"></div>
</div>

<button id="exitFullscreen">رجوع</button>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  let map, marker;
  const container = document.getElementById('map-container');
  const exitBtn = document.getElementById("exitFullscreen");

  // فتح IndexedDB
  function openDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open("MapDB", 1);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        db.createObjectStore("locations", { keyPath: "id" });
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  // حفظ الموقع
  async function saveLocation(lat, lng) {
    const db = await openDB();
    const tx = db.transaction("locations", "readwrite");
    const store = tx.objectStore("locations");
    store.put({ id: "last", lat, lng });
    tx.oncomplete = () => db.close();
  }

  // جلب الموقع المحفوظ
  async function getSavedLocation() {
    const db = await openDB();
    return new Promise((resolve) => {
      const tx = db.transaction("locations", "readonly");
      const store = tx.objectStore("locations");
      const request = store.get("last");
      request.onsuccess = () => {
        db.close();
        resolve(request.result ? [request.result.lat, request.result.lng] : null);
      };
      request.onerror = () => {
        db.close();
        resolve(null);
      };
    });
  }

  // تهيئة الخريطة
  async function initMap() {
    const savedLocation = await getSavedLocation();
    const defaultLocation = [24.7136, 46.6753]; // الرياض
    const startLocation = savedLocation || defaultLocation;
    const zoomLevel = savedLocation ? 15 : 13;

    map = L.map('map').setView(startLocation, zoomLevel);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    if (savedLocation) {
      marker = L.marker(savedLocation).addTo(map);
    }

    // تحديد موقع جديد
    map.on('click', async function(e) {
      const latlng = [e.latlng.lat, e.latlng.lng];
      if (marker) map.removeLayer(marker);
      marker = L.marker(latlng).addTo(map);
      await saveLocation(latlng[0], latlng[1]);
      map.setView(latlng, 15);
    });
  }

  // تكبير الخريطة
  container.addEventListener('click', function () {
    if (!container.classList.contains('fullscreen')) {
      container.classList.add('fullscreen');
      exitBtn.style.display = 'block';
      setTimeout(() => map.invalidateSize(), 310);
    }
  });

  // زر الرجوع
  exitBtn.addEventListener('click', () => {
    container.classList.remove('fullscreen');
    exitBtn.style.display = 'none';
    setTimeout(() => map.invalidateSize(), 310);
  });

  // تشغيل الخريطة
  initMap();
</script>

</body>
</html>
